<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem B√†i Tarot - ƒê·∫∑t C√¢u H·ªèi & AI Ph√¢n T√≠ch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif; 
            background-color: #0a0a12; 
            overflow-x: hidden;
            color: #EAE0C8; 
            padding-top: 1rem; 
        }

        #animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -10; 
            overflow: hidden;
            background-image: url('cid:uploaded:76363ee1c9bed71a54cfe87982e86447.jpg-cf7bdb21-8076-425c-afd3-2e18ec3d669b'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat; 
        }
 
        #question-section-content h2, 
        .tarot-card-front, 
        .btn-action, 
        .card-info-title, 
        .ai-title, 
        #display-user-question
        {
            font-family: 'Playfair Display', serif; 
        }
        .tarot-card-front {
            font-family: 'IM Fell English SC', serif;
        }


        #question-section-content h2 { font-weight: 600; font-size: 1.75rem; color: #FFD700; }
        .ai-title { font-weight: 700; font-size: 1.75rem; }
        .card-info-title { font-weight: 600; font-size: 1.3rem; } 
        .btn-action { font-weight: 600; } 
        #display-user-question { font-weight: 400; font-style: italic; font-size: 1.1rem; color: #F5DEB3; }


        p, 
        #user-question-input::placeholder, 
        .card-info-meaning, 
        .ai-text, 
        .ai-text .highlighted-card-name, 
        .ai-text strong, 
        .ai-text em,
        #initial-info-message, 
        #message-text
        {
             font-family: 'Inter', sans-serif;
        }
        #user-question-input {
            font-family: 'Playfair Display', serif;
        }

        .tarot-card-front span { 
            font-size: 2.5rem; 
        }


        .firefly {
            position: absolute;
            width: 3px;
            height: 3px;
            background-color: rgba(220, 255, 170, 0.8); 
            border-radius: 50%;
            box-shadow: 0 0 6px 2px rgba(220, 255, 170, 0.7), 
                        0 0 10px 4px rgba(255, 255, 224, 0.5); 
            animation: firefly-movement 10s infinite;
            opacity: 0; 
        }

        @keyframes firefly-movement {
            0%, 100% { opacity: 0.3; transform: scale(0.8) translate(0,0); }
            25% { opacity: 1; transform: scale(1.2) translate(20px, -30px); }
            50% { opacity: 0.8; transform: scale(1) translate(-15px, 25px); }
            75% { opacity: 1; transform: scale(1.1) translate(10px, 15px); }
        }

        .firefly:nth-child(1) { top: 20%; left: 10%; animation-duration: 12s; animation-delay: 0s; }
        .firefly:nth-child(2) { top: 50%; left: 80%; animation-duration: 9s; animation-delay: 1s; width: 2px; height: 2px;}
        .firefly:nth-child(3) { top: 80%; left: 30%; animation-duration: 15s; animation-delay: 2.5s; }
        .firefly:nth-child(4) { top: 10%; left: 90%; animation-duration: 10s; animation-delay: 4s; width: 4px; height: 4px;}
        .firefly:nth-child(5) { top: 65%; left: 50%; animation-duration: 13s; animation-delay: 1.5s; }
        .firefly:nth-child(6) { top: 35%; left: 60%; animation-duration: 11s; animation-delay: 3s; width: 2px; height: 2px;}
        .firefly:nth-child(7) { top: 90%; left: 5%; animation-duration: 14s; animation-delay: 0.5s; }
        .firefly:nth-child(8) { top: 5%; left: 40%; animation-duration: 8s; animation-delay: 5s; }
        .firefly:nth-child(9) { top: 40%; left: 20%; animation-duration: 12s; animation-delay: 2s; width:3px; height:3px;}
        .firefly:nth-child(10) { top: 75%; left: 70%; animation-duration: 10s; animation-delay: 3.5s; }

        .card-base {
            width: 100px; 
            height: 170px; 
            border-radius: 8px;
            background-color: #A0522D; 
            border: 2px solid #8B4513;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'IM Fell English SC', serif;
            color: #F5DEB3;
            font-size: 1.8rem;
            position: absolute; 
        }

        #deck-pile {
            position: relative; 
            width: 110px; 
            height: 180px;
            margin: 20px auto; 
            cursor: pointer; 
        }
        #deck-pile .card-base {
            transition: transform 0.3s ease-out;
        }
        #deck-pile.shuffling .card-base:nth-child(1) { transform: translate(5px, -5px) rotate(5deg); }
        #deck-pile.shuffling .card-base:nth-child(2) { transform: translate(-5px, 0px) rotate(-3deg); }
        #deck-pile.shuffling .card-base:nth-child(3) { transform: translate(3px, 5px) rotate(2deg); }


        #cards-display-area {
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 200px; 
            gap: 20px; 
            margin-bottom: 2rem;
        }

        .tarot-card-slot {
            width: 100px; 
            height: 170px;
            perspective: 1000px;
            border-radius: 8px;
            position: relative; 
        }

        .tarot-card-inner {
            position: absolute; 
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s, opacity 0.5s;
            transform-style: preserve-3d;
            border-radius: 8px;
            cursor: pointer;
            opacity: 0; 
        }
        .tarot-card-inner.dealt {
            opacity: 1;
        }

        .tarot-card-slot.flipped .tarot-card-inner {
            transform: rotateY(180deg);
        }

        .tarot-card-front, .tarot-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .tarot-card-front { 
            background-color: #A0522D;
            color: #F5DEB3;
            border: 2px solid #8B4513;
        }
        .tarot-card-front span { font-size: 2rem; }


        .tarot-card-back {
            background-color: #F5F5DC; /* M√†u n·ªÅn m·∫∑c ƒë·ªãnh cho m·∫∑t th·∫ª, s·∫Ω b·ªã ·∫£nh che */
            color: #5D4037;
            transform: rotateY(180deg);
            overflow: hidden;
        }

        .tarot-card-back img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            border-radius: 8px;
            background-color: #F5F5DC; /* M√†u n·ªÅn fallback cho th·∫ª img n·∫øu ·∫£nh l·ªói */
        }

        .btn-action { 
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .btn-submit-question {
            background-color: #FFD700; 
            color: #4A2311; 
            border: 1px solid #B8860B; 
            text-shadow: none; 
            font-size: 1.1rem; 
            padding-top: 0.85rem; 
            padding-bottom: 0.85rem;
        }
        .btn-submit-question:hover {
            background-color: #F0C000; 
            color: #3D1B0C;
        }
        #reset-cards-button {
            background-color: #8B0000; 
            color: #FFEBCD; 
            border: 1px solid #580000;
            font-size: 1.1rem;
            padding-top: 0.85rem; 
            padding-bottom: 0.85rem;
        }
        #reset-cards-button:hover {
            background-color: #580000; 
        }


        .info-section-container {
            background-color: rgba(40, 20, 0, 0.85); 
            backdrop-filter: blur(8px);
            border: 1px solid rgba(210, 180, 140, 0.3); 
            border-radius: 12px;
            padding: 25px;
            margin-top: 1rem; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 720px;
        }
        .card-info-title { 
            color: #FFD700; 
            margin-bottom: 5px;
        }
        .card-info-meaning { 
            font-size: 0.95rem;
            color: #F5F5DC; 
            line-height: 1.7;
            margin-bottom: 15px;
        }
        .ai-interpretation-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(210, 180, 140, 0.4); 
        }
        .ai-title { 
            font-size: 1.75rem; 
            color: #DAA520; 
            margin-bottom: 10px;
            text-align: center;
        }
        .ai-text { 
            font-size: 1rem;
            color: #EAE0C8; 
            line-height: 1.8;
            white-space: pre-wrap;
        }
        .ai-text .highlighted-card-name { 
            color: #FFDEAD; 
            font-weight: bold; 
        }
        .ai-text strong { 
            color: #FFB74D; 
            font-weight: bold; 
        }
        .ai-text em { 
            color: #FFE0B2; 
            font-style: italic;
        }
        
        #question-section-content { 
            background-color: rgba(60, 40, 20, 0.7); 
            backdrop-filter: blur(5px); 
            padding: 30px;
            border-radius: 1rem; 
            margin-bottom: 30px; 
            width: 100%;
            max-width: 700px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.4); 
            border: 1px solid rgba(210, 180, 140, 0.25); 
        }
        #question-section-content h2 { 
             color: #FFD700; 
             margin-bottom: 1.25rem; 
        }

        #user-question-input { 
            background-color: transparent; 
            border: none; 
            color: #FFF8DC; 
            padding: 0.75rem 0.25rem; 
            border-radius: 0; 
            font-size: 1.6rem; 
            line-height: 1.5; 
            min-height: 80px; 
            resize: none; 
            outline: none; 
            width: 100%; 
            text-align: center; 
        }

        #user-question-input::placeholder { 
            color: rgba(210, 180, 140, 0.7); 
            font-family: 'Playfair Display', serif; 
            font-style: italic;
            font-size: 1.6rem; 
            animation: blink-placeholder 1.5s infinite;
            text-align: center; 
        }

        #user-question-input:focus::placeholder {
            animation: none;
            opacity: 0.4;
        }
        #user-question-input:not(:placeholder-shown)::placeholder {
            display: none;
        }


        @keyframes blink-placeholder {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }


        .transitionable-section {
            transition: opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1), transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
        }

        .section-hidden-state {
            opacity: 0;
            transform: translateY(30px) scale(0.95); 
            pointer-events: none;
        }

        .section-visible-state {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .loader {
            border: 5px solid #8B4513; 
            border-top: 5px solid #FFD700; 
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div id="animated-background">
        </div>

    <div class="w-full max-w-3xl mx-auto text-center relative z-10"> 
        <div id="question-section-wrapper" class="transitionable-section">
            <div id="question-section-content">
                <h2 class="mb-5">N√≥i cho ta bi·∫øt, ƒëi·ªÅu g√¨ ng∆∞∆°i t√¨m ki·∫øm?</h2>
                <textarea id="user-question-input" placeholder="V√≠ d·ª•: Con ƒë∆∞·ªùng n√†o ƒëang m·ªü ra cho ta?"></textarea>
                <button id="submit-question-button" class="btn-action btn-submit-question py-3 px-8 rounded-lg shadow-md mt-6 w-full focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
                    Kh√°m Ph√° Th√¥ng ƒêi·ªáp Tarot
                </button>
            </div>
        </div>

        <div id="tarot-reading-section-wrapper" class="transitionable-section hidden">
            <div id="tarot-reading-section-content">
                <p id="display-user-question" class="mt-2 mb-6"></p>
                
                <div id="deck-container" class="mb-8 hidden"> <p class="text-amber-200 mb-2 text-lg">ƒêang x√†o b√†i...</p>
                    <div id="deck-pile">
                        </div>
                </div>

                <div id="cards-display-area" class="mb-8 flex flex-wrap justify-center items-start">
                    <div id="card-slot-0" class="tarot-card-slot">
                        <div class="tarot-card-inner" data-card-index="0">
                            <div class="tarot-card-front"><span>üÇ†</span></div>
                            <div class="tarot-card-back">
                                <img src="" alt="L√° b√†i 1" id="card-img-0">
                            </div>
                        </div>
                    </div>
                    <div id="card-slot-1" class="tarot-card-slot">
                        <div class="tarot-card-inner" data-card-index="1">
                            <div class="tarot-card-front"><span>üÇ†</span></div>
                            <div class="tarot-card-back">
                                <img src="" alt="L√° b√†i 2" id="card-img-1">
                            </div>
                        </div>
                    </div>
                    <div id="card-slot-2" class="tarot-card-slot">
                        <div class="tarot-card-inner" data-card-index="2">
                            <div class="tarot-card-front"><span>üÇ†</span></div>
                            <div class="tarot-card-back">
                                <img src="" alt="L√° b√†i 3" id="card-img-2">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reset-button-container" class="mt-6 mb-4 hidden">
                    <button id="reset-cards-button" class="btn-action py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                        H·ªèi L·ªùi S·∫•m Kh√°c
                    </button>
                </div>

                <div id="info-display-section" class="info-section-container text-left hidden">
                    <div id="original-meanings-container">
                        <p id="initial-info-message" class="text-amber-100 text-center text-lg">L·ªùi ti√™n tri ƒëang ch·ªù ƒë·ª£i... H√£y ch·ªçn m·ªôt l√° b√†i!</p>
                        <div id="card-info-0" class="mb-4 p-3 bg-black bg-opacity-30 rounded-md hidden">
                            <h3 id="card-name-0" class="card-info-title"></h3>
                            <p id="card-meaning-0" class="card-info-meaning"></p>
                        </div>
                        <div id="card-info-1" class="mb-4 p-3 bg-black bg-opacity-30 rounded-md hidden">
                            <h3 id="card-name-1" class="card-info-title"></h3>
                            <p id="card-meaning-1" class="card-info-meaning"></p>
                        </div>
                        <div id="card-info-2" class="p-3 bg-black bg-opacity-30 rounded-md hidden">
                            <h3 id="card-name-2" class="card-info-title"></h3>
                            <p id="card-meaning-2" class="card-info-meaning"></p>
                        </div>
                    </div>

                    <div id="ai-interpretation-container" class="ai-interpretation-container hidden">
                        <h2 class="ai-title">üìú L·ªùi Gi·∫£i T·ª´ V√¨ Sao üìú</h2>
                        <div id="ai-loading-indicator" class="loader hidden"></div>
                        <p id="ai-interpretation-text" class="ai-text"></p>
                    </div>
                </div>
            </div>
        </div>

         <div id="message-box" class="fixed top-5 right-5 bg-red-700 text-gray-100 p-4 rounded-lg shadow-xl hidden animate-pulse z-50">
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // DOM Elements
        const animatedBackground = document.getElementById('animated-background');
        const questionSectionWrapper = document.getElementById('question-section-wrapper');
        const tarotReadingSectionWrapper = document.getElementById('tarot-reading-section-wrapper');
        
        const userQuestionInput = document.getElementById('user-question-input');
        const submitQuestionButton = document.getElementById('submit-question-button');
        const displayUserQuestionElement = document.getElementById('display-user-question');

        const deckContainer = document.getElementById('deck-container');
        const deckPile = document.getElementById('deck-pile');
        const cardSlotsElements = [ 
            document.getElementById('card-slot-0'),
            document.getElementById('card-slot-1'),
            document.getElementById('card-slot-2')
        ];
        const cardInnerElements = document.querySelectorAll('#cards-display-area .tarot-card-inner');


        const cardImages = [ 
            document.getElementById('card-img-0'), 
            document.getElementById('card-img-1'),
            document.getElementById('card-img-2')
        ];
        const cardInfoDivs = [
            document.getElementById('card-info-0'), 
            document.getElementById('card-info-1'),
            document.getElementById('card-info-2')
        ];
        const cardNamesElements = [
            document.getElementById('card-name-0'), 
            document.getElementById('card-name-1'),
            document.getElementById('card-name-2')
        ];
        const cardMeaningsElements = [
            document.getElementById('card-meaning-0'), 
            document.getElementById('card-meaning-1'),
            document.getElementById('card-meaning-2')
        ];
        const initialInfoMessage = document.getElementById('initial-info-message');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const resetButtonContainer = document.getElementById('reset-button-container');
        const resetButton = document.getElementById('reset-cards-button');

        const infoDisplaySection = document.getElementById('info-display-section');
        const originalMeaningsContainer = document.getElementById('original-meanings-container');
        const aiInterpretationContainer = document.getElementById('ai-interpretation-container');
        const aiLoadingIndicator = document.getElementById('ai-loading-indicator');
        const aiInterpretationTextElement = document.getElementById('ai-interpretation-text');

        /*
         * QUAN TR·ªåNG: ƒê√¢y l√† n∆°i b·∫°n s·∫Ω c·∫≠p nh·∫≠t URL h√¨nh ·∫£nh l√° b√†i Tarot th·ª±c t·∫ø.
         * C√°c URL d∆∞·ªõi ƒë√¢y l√† t·ª´ postimg.cc b·∫°n ƒë√£ cung c·∫•p cho 22 l√° Major Arcana.
         * N·∫øu mu·ªën s·ª≠ d·ª•ng to√†n b·ªô 78 l√°, b·∫°n c·∫ßn m·ªü r·ªông danh s√°ch n√†y v√† c√≥ th·ªÉ c·∫ßn ƒëi·ªÅu ch·ªânh logic r√∫t b√†i.
        */
        const tarotDeck = [
            // Major Arcana (22 l√°) - S·ª≠ d·ª•ng URL t·ª´ postimg.cc
            { name: "0 - The Fool", nameParts: ["The Fool", "Fool"], meaning: "S·ª± kh·ªüi ƒë·∫ßu m·ªõi, ng√¢y th∆°, phi√™u l∆∞u, ti·ªÅm nƒÉng kh√¥ng gi·ªõi h·∫°n, s·ª± t·ª± ph√°t.", img: "https://i.postimg.cc/5ND6VgDK/643e305b9f205802596736.jpg" }, 
            { name: "I - The Magician", nameParts: ["The Magician", "Magician"], meaning: "S·ª©c m·∫°nh √Ω ch√≠, k·ªπ nƒÉng, h√†nh ƒë·ªông, t·∫≠p trung, bi·ªÉu hi·ªán, t√†i nguy√™n.", img: "https://i.postimg.cc/5NpW52SB/643f51cebd6fc372602918.jpg" }, 
            { name: "II - The High Priestess", nameParts: ["The High Priestess", "High Priestess"], meaning: "Tr·ª±c gi√°c, b√≠ ·∫©n, ti·ªÅm th·ª©c, tr√≠ tu·ªá n·ªôi t√¢m, s·ª± ki√™n nh·∫´n.", img: "https://i.postimg.cc/9XnGDGvZ/6440bfeb45daa924620828.jpg" }, 
            { name: "III - The Empress", nameParts: ["The Empress", "Empress"], meaning: "S·ª± nu√¥i d∆∞·ª°ng, phong ph√∫, n·ªØ t√≠nh, s√°ng t·∫°o, v·∫ª ƒë·∫πp t·ª± nhi√™n, s·ª± sinh s√¥i.", img: "https://i.postimg.cc/sxh4Jc8B/64421dc3642e5331994313.jpg" }, 
            { name: "IV - The Emperor", nameParts: ["The Emperor", "Emperor"], meaning: "Quy·ªÅn l·ª±c, c·∫•u tr√∫c, s·ª± ki·ªÉm so√°t, l√Ω tr√≠, ng∆∞·ªùi cha, s·ª± ·ªïn ƒë·ªãnh.", img: "https://i.postimg.cc/Nfb5zTcL/6440ca04423aa803088771.jpg" }, 
            { name: "V - The Hierophant", nameParts: ["The Hierophant", "Hierophant"], meaning: "Truy·ªÅn th·ªëng, ƒë·ª©c tin, gi√°o d·ª•c, h∆∞·ªõng d·∫´n tinh th·∫ßn, s·ª± tu√¢n th·ªß.", img: "https://i.postimg.cc/wjygQsxC/6442143cc6d12721675057.jpg" }, 
            { name: "VI - The Lovers", nameParts: ["The Lovers", "Lovers"], meaning: "T√¨nh y√™u, m·ªëi quan h·ªá, s·ª± l·ª±a ch·ªçn, s·ª± h√≤a h·ª£p, gi√° tr·ªã, s·ª± li√™n k·∫øt.", img: "https://i.postimg.cc/hG4F3zK4/643f75de5fa42187988494.jpg" }, 
            { name: "VII - The Chariot", nameParts: ["The Chariot", "Chariot"], meaning: "√ù ch√≠, quy·∫øt t√¢m, chi·∫øn th·∫Øng, s·ª± ki·ªÉm so√°t, ti·∫øn v·ªÅ ph√≠a tr∆∞·ªõc, s·ª± t·ª± tin.", img: "https://i.postimg.cc/j2PkjtRk/64466e1bb9588170152785.jpg" }, 
            { name: "VIII - Strength", nameParts: ["Strength"], meaning: "S·ª©c m·∫°nh n·ªôi t√¢m, l√≤ng d≈©ng c·∫£m, s·ª± ki√™n nh·∫´n, ki·ªÉm so√°t b·∫£n nƒÉng, l√≤ng tr·∫Øc ·∫©n.", img: "https://i.postimg.cc/mg2VvQ1n/6446754309a08059278429.jpg" }, 
            { name: "IX - The Hermit", nameParts: ["The Hermit", "Hermit"], meaning: "S·ª± suy ng·∫´m, c√¥ t·ªãch, t√¨m ki·∫øm n·ªôi t√¢m, tr√≠ tu·ªá, h∆∞·ªõng d·∫´n, s·ª± t·ª± gi√°c.", img: "https://i.postimg.cc/4xmVvw9X/644776cd15b36247793217.jpg" }, 
            { name: "X - Wheel of Fortune", nameParts: ["Wheel of Fortune", "Wheel"], meaning: "Chu k·ª≥, s·ªë ph·∫≠n, s·ª± thay ƒë·ªïi, may m·∫Øn, b∆∞·ªõc ngo·∫∑t, c∆° h·ªôi.", img: "https://i.postimg.cc/qRjv5VPS/6448a1d65ca2c307025465.jpg" }, 
            { name: "XI - Justice", nameParts: ["Justice"], meaning: "S·ª± th·∫≠t, c√¥ng b·∫±ng, lu·∫≠t nh√¢n qu·∫£, tr√°ch nhi·ªám, s·ª± r√µ r√†ng, quy·∫øt ƒë·ªãnh.", img: "https://i.postimg.cc/J7ss2thQ/64477df6d145b114005354.jpg" }, 
            { name: "XII - The Hanged Man", nameParts: ["The Hanged Man", "Hanged Man"], meaning: "S·ª± hy sinh, g√≥c nh√¨n m·ªõi, bu√¥ng b·ªè, ƒë√¨nh ch·ªâ, s·ª± ki√™n nh·∫´n.", img: "https://i.postimg.cc/pXV6vNgk/6448ab982e324297578895.jpg" }, 
            { name: "XIII - Death", nameParts: ["Death"], meaning: "S·ª± k·∫øt th√∫c, chuy·ªÉn ƒë·ªïi, t√°i sinh.", img: "https://i.postimg.cc/g0pR9p72/6449de96464fc931611065.jpg" }, 
            { name: "XIV - Temperance", nameParts: ["Temperance"], meaning: "S·ª± c√¢n b·∫±ng, ƒëi·ªÅu ƒë·ªô, h√≤a h·ª£p.", img: "https://i.postimg.cc/jS46SCP7/644a8f06a2a97262712511.jpg" }, 
            { name: "XV - The Devil", nameParts: ["The Devil", "Devil"], meaning: "S·ª± r√†ng bu·ªôc, c√°m d·ªó, nghi·ªán ng·∫≠p.", img: "https://i.postimg.cc/L6Bgzw5d/644b42ed90c7e737329635.jpg" }, 
            { name: "XVI - The Tower", nameParts: ["The Tower", "Tower"], meaning: "S·ª± thay ƒë·ªïi ƒë·ªôt ng·ªôt, bi·∫øn ƒë·ªông.", img: "https://i.postimg.cc/qMjMBTg7/644b642cce4fe891891452.jpg" }, 
            { name: "XVII - The Star", nameParts: ["The Star", "Star"], meaning: "Hy v·ªçng, c·∫£m h·ª©ng, ni·ªÅm tin.", img: "https://i.postimg.cc/vHcHmKnL/6450948daadbc805081217.jpg" }, 
            { name: "XVIII - The Moon", nameParts: ["The Moon", "Moon"], meaning: "Tr·ª±c gi√°c, ·∫£o ·∫£nh, n·ªói s·ª£.", img: "https://i.postimg.cc/fbKJd9Rx/6450a08c8eb21261517572.jpg" }, 
            { name: "XIX - The Sun", nameParts: ["The Sun", "Sun"], meaning: "Ni·ªÅm vui, th√†nh c√¥ng, s·ª± r√µ r√†ng.", img: "https://i.postimg.cc/Kv0btDPc/642c49cb896c6121395135.png" }, 
            { name: "XX - Judgement", nameParts: ["Judgement"], meaning: "S·ª± ph√°n x√©t, s·ª± th·ª©c t·ªânh, s·ª± tha th·ª©.", img: "https://i.postimg.cc/k5bDjpsv/642c49bf40ad6363634537.png" }, // L∆∞u √Ω: Link ·∫£nh n√†y gi·ªëng v·ªõi The World, b·∫°n c√≥ th·ªÉ c·∫ßn ki·ªÉm tra l·∫°i
            { name: "XXI - The World", nameParts: ["The World", "World"], meaning: "S·ª± ho√†n th√†nh, th√†nh t·ª±u, tr·ªçn v·∫πn.", img: "https://i.postimg.cc/k5bDjpsv/642c49bf40ad6363634537.png" } // L∆∞u √Ω: Link ·∫£nh n√†y gi·ªëng v·ªõi Judgement
            // N·∫øu b·∫°n mu·ªën s·ª≠ d·ª•ng to√†n b·ªô 78 l√°, h√£y th√™m c√°c l√° Minor Arcana v√†o ƒë√¢y
            // v·ªõi ƒë·ªãnh d·∫°ng t∆∞∆°ng t·ª±, v√≠ d·ª•:
            // { name: "Ace of Wands", nameParts: ["Ace of Wands"], meaning: "√ù nghƒ©a c·ªßa Ace of Wands...", img: "URL_CUA_BAN_CHO_ACE_OF_WANDS" },
            // ... (ti·∫øp t·ª•c cho c√°c l√° c√≤n l·∫°i)
        ];


        let revealedCount = 0;
        let availableCards = [];
        let drawnCardsData = []; 
        let currentUserQuestion = "";
        let isDealing = false; 

        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, duration);
        }

        function enableResetButton() { resetButtonContainer.classList.remove('hidden'); }
        function disableResetButton() { resetButtonContainer.classList.add('hidden'); }
        function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

        function createFireflies(count) {
            for (let i = 0; i < count; i++) {
                const firefly = document.createElement('div');
                firefly.classList.add('firefly');
                firefly.style.top = `${Math.random() * 100}%`;
                firefly.style.left = `${Math.random() * 100}%`;
                firefly.style.animationDelay = `${Math.random() * 5}s`; 
                firefly.style.animationDuration = `${8 + Math.random() * 7}s`; 
                if (Math.random() > 0.6) { 
                    const size = `${2 + Math.random() * 2}px`;
                    firefly.style.width = size;
                    firefly.style.height = size;
                }
                animatedBackground.appendChild(firefly);
            }
        }

        function createDeckVisual() {
            deckPile.innerHTML = ''; 
            for (let i = 0; i < 5; i++) { 
                const cardEl = document.createElement('div');
                cardEl.classList.add('card-base');
                cardEl.style.bottom = `${i * 2}px`; 
                cardEl.style.left = `${i * 1}px`;
                cardEl.style.transform = `rotate(${Math.random() * 4 - 2}deg)`; 
                cardEl.textContent = 'üÇ†'; 
                deckPile.appendChild(cardEl);
            }
        }

        async function shuffleAndDeal() {
            isDealing = true;
            deckContainer.classList.remove('hidden');
            deckPile.classList.add('shuffling');
            deckContainer.querySelector('p').textContent = "ƒêang x√†o b√†i...";
            
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            deckPile.classList.remove('shuffling');
            deckContainer.querySelector('p').textContent = "ƒêang chia b√†i...";

            drawnCardsData = []; 
            // Ch·ªâ r√∫t t·ª´ Major Arcana n·∫øu tarotDeck ch·ªâ ch·ª©a Major Arcana
            // N·∫øu tarotDeck ch·ª©a c·∫£ 78 l√°, logic n√†y v·∫´n ho·∫°t ƒë·ªông ƒë·ªÉ r√∫t ng·∫´u nhi√™n t·ª´ to√†n b·ªô
            availableCards = [...tarotDeck]; 

            for (let i = 0; i < 3; i++) {
                if (availableCards.length === 0) break;

                const randomIndex = Math.floor(Math.random() * availableCards.length);
                const selectedCardData = availableCards.splice(randomIndex, 1)[0];
                
                const cardInnerEl = cardInnerElements[i];
                const cardSlotEl = cardSlotsElements[i];
                const cardImgEl = cardInnerEl.querySelector('.tarot-card-back img');
                const cardFrontSymbolEl = cardInnerEl.querySelector('.tarot-card-front span');

                drawnCardsData.push({ data: selectedCardData, element: cardInnerEl, slot: cardSlotEl });

                cardFrontSymbolEl.textContent = 'üÇ†'; 
                cardImgEl.src = ""; 
                cardImgEl.alt = selectedCardData.name;
                
                const movingCard = document.createElement('div');
                movingCard.classList.add('card-base');
                movingCard.textContent = 'üÇ†';
                movingCard.style.position = 'fixed'; 
                const deckRect = deckPile.getBoundingClientRect();
                movingCard.style.left = `${deckRect.left + window.scrollX}px`;
                movingCard.style.top = `${deckRect.top + window.scrollY}px`;
                document.body.appendChild(movingCard);

                await new Promise(resolve => setTimeout(resolve, 200)); 

                const slotRect = cardSlotEl.getBoundingClientRect();
                movingCard.style.transition = 'transform 0.5s ease-in-out, opacity 0.5s ease-in-out';
                movingCard.style.transform = `translate(${slotRect.left + window.scrollX - deckRect.left}px, ${slotRect.top + window.scrollY - deckRect.top}px) rotateY(0deg)`;
                movingCard.style.opacity = '1';

                await new Promise(resolve => setTimeout(resolve, 500)); 
                
                document.body.removeChild(movingCard);
                cardInnerEl.classList.add('dealt'); 
            }
            deckContainer.classList.add('hidden');
            initialInfoMessage.classList.remove('hidden');
            infoDisplaySection.classList.remove('hidden'); 
            isDealing = false;
        }


        async function getAIInterpretation(cardsInfo, userQuestion) {
            aiInterpretationContainer.classList.remove('hidden');
            aiLoadingIndicator.classList.remove('hidden');
            aiInterpretationTextElement.innerHTML = '';
            const cardFullNames = cardsInfo.map(ci => ci.data.name);

            const prompt = `B·∫°n l√† m·ªôt ng∆∞·ªùi ƒë·ªçc b√†i Tarot uy√™n b√°c v√† huy·ªÅn b√≠, mang gi·ªçng vƒÉn c·ªï x∆∞a nh∆∞ m·ªôt nh√† ti√™n tri. Ng∆∞·ªùi t√¨m ki·∫øm c√≥ m·ªôt th·∫Øc m·∫Øc: "${userQuestion}". H·ªç ƒë√£ r√∫t ƒë∆∞·ª£c 3 l√° b√†i thi√™ng: ${cardFullNames.join(', ')}. D·ª±a tr√™n s·ª± th√¥ng tu·ªá Tarot c·ªßa b·∫°n, h√£y v√©n m√†n b√≠ m·∫≠t, gi·∫£i th√≠ch √Ω nghƒ©a t·ªïng h·ª£p c·ªßa 3 l√° b√†i n√†y trong m·ªëi li√™n h·ªá v·ªõi c√¢u h·ªèi c·ªßa h·ªç. H√£y ƒë∆∞a ra m·ªôt l·ªùi s·∫•m truy·ªÅn chi ti·∫øt, s√¢u s·∫Øc v√† mang t√≠nh ch·ªâ d·∫´n. Trong l·ªùi ti√™n tri c·ªßa b·∫°n, h√£y nh·∫•n m·∫°nh nh·ªØng t·ª´ kh√≥a ho·∫∑c kh√°i ni·ªám Tarot quan tr·ªçng b·∫±ng c√°ch ƒë·∫∑t ch√∫ng trong d·∫•u hai hoa th·ªã (v√≠ d·ª•: **v·∫≠n m·ªánh** ho·∫∑c **kh·ªüi ƒë·∫ßu m·ªõi**).`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json(); throw new Error(`L·ªói t·ª´ c√°c v√¨ sao: ${errorData.error?.message || response.statusText}`);
                }
                const result = await response.json();
                let rawText = "";
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    rawText = result.candidates[0].content.parts[0].text;
                } else { throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c l·ªùi s·∫•m truy·ªÅn h·ª£p l·ªá."); }

                let processedText = rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                const allNameParts = cardsInfo.flatMap(ci => ci.data.nameParts).sort((a, b) => b.length - a.length);
                let tempText = processedText;
                [...new Set(allNameParts)].forEach(part => {
                    tempText = tempText.replace(new RegExp(`\\b${escapeRegExp(part)}\\b`, 'gi'), (match) => `<span class="highlighted-card-name">${match}</span>`);
                });
                aiInterpretationTextElement.innerHTML = tempText;
            } catch (error) {
                console.error("L·ªói khi gi·∫£i l·ªùi s·∫•m:", error);
                aiInterpretationTextElement.innerHTML = `R·∫•t ti·∫øc, c√°c v√¨ sao ch∆∞a th·ªÉ h·ªìi ƒë√°p: ${error.message}. Xin h√£y th·ª≠ l·∫°i sau.`;
                showMessage(`L·ªói s·∫•m truy·ªÅn: ${error.message}`, 5000);
            } finally {
                aiLoadingIndicator.classList.add('hidden');
            }
        }

        function resetIndividualCardSlot(index) {
            const cardInnerEl = cardInnerElements[index];
            const cardSlotEl = cardSlotsElements[index];
            cardInnerEl.classList.remove('flipped', 'dealt');
            cardInnerEl.style.transform = ''; 
            cardSlotEl.classList.remove('flipped'); 
            
            const imgEl = cardInnerEl.querySelector('.tarot-card-back img');
            imgEl.src = ""; 
            imgEl.alt = `L√° b√†i ${index + 1}`;
            const cardFrontSymbolEl = cardInnerEl.querySelector('.tarot-card-front span');
            cardFrontSymbolEl.textContent = 'üÇ†'; 

            cardInfoDivs[index].classList.add('hidden');
            cardNamesElements[index].textContent = '';
            cardMeaningsElements[index].textContent = '';
        }

        function resetTarotReadingView() {
            cardInnerElements.forEach((el, index) => resetIndividualCardSlot(index));
            initialInfoMessage.classList.remove('hidden'); 
            infoDisplaySection.classList.add('hidden'); 
            aiInterpretationContainer.classList.add('hidden');
            aiInterpretationTextElement.innerHTML = '';
            aiLoadingIndicator.classList.add('hidden');
            disableResetButton();
            revealedCount = 0; 
            drawnCardsData = []; 
        }
        
        function showSection(sectionToShow, sectionToHide) {
            sectionToHide.classList.remove('section-visible-state');
            sectionToHide.classList.add('section-hidden-state');
            setTimeout(() => {
                sectionToHide.classList.add('hidden'); 
                sectionToShow.classList.remove('hidden'); 
                requestAnimationFrame(() => {
                    sectionToShow.classList.remove('section-hidden-state');
                    sectionToShow.classList.add('section-visible-state');
                });
            }, 700); 
        }

        function initializeNewReadingSession() {
            resetTarotReadingView();
            availableCards = [...tarotDeck];
            questionSectionWrapper.classList.remove('hidden', 'section-hidden-state');
            questionSectionWrapper.classList.add('section-visible-state');
            tarotReadingSectionWrapper.classList.remove('section-visible-state');
            tarotReadingSectionWrapper.classList.add('section-hidden-state', 'hidden'); 
            userQuestionInput.value = '';
            currentUserQuestion = "";
            if (tarotDeck.length < 3) { showMessage("B·ªô b√†i kh√¥ng ƒë·ªß 3 l√° ƒë·ªÉ tr·∫£i.", 5000); }
        }

        submitQuestionButton.addEventListener('click', async () => {
            const question = userQuestionInput.value.trim();
            if (!question) { showMessage("Xin h√£y cho bi·∫øt ƒëi·ªÅu ng∆∞∆°i trƒÉn tr·ªü."); return; }
            currentUserQuestion = question;
            displayUserQuestionElement.textContent = `L·ªùi th·ªânh c·∫ßu c·ªßa ng∆∞∆°i: "${currentUserQuestion}"`;
            
            showSection(tarotReadingSectionWrapper, questionSectionWrapper);
            resetTarotReadingView(); 
            createDeckVisual(); 
            await shuffleAndDeal(); 
        });

        cardInnerElements.forEach((cardInnerEl, index) => {
            cardInnerEl.addEventListener('click', () => {
                if (isDealing || !cardInnerEl.classList.contains('dealt') || cardInnerEl.parentElement.classList.contains('flipped')) {
                    return; 
                }

                const cardDataObj = drawnCardsData[index]; 
                if (!cardDataObj) return; 
                
                const selectedCard = cardDataObj.data;
                const imgEl = cardInnerEl.querySelector('.tarot-card-back img');
                imgEl.src = selectedCard.img; 

                cardInnerEl.parentElement.classList.add('flipped');
                revealedCount++;

                cardNamesElements[index].textContent = selectedCard.name;
                cardMeaningsElements[index].textContent = selectedCard.meaning;
                cardInfoDivs[index].classList.remove('hidden');
                initialInfoMessage.classList.add('hidden');


                if (revealedCount === 3) {
                    enableResetButton();
                    getAIInterpretation(drawnCardsData, currentUserQuestion);
                }
            });
        });


        resetButton.addEventListener('click', () => {
            showSection(questionSectionWrapper, tarotReadingSectionWrapper);
             setTimeout(() => { initializeNewReadingSession(); }, 50);
        });

        window.onload = () => {
            initializeNewReadingSession();
            createFireflies(10); 
            cardImages.forEach((imgElem) => {
                imgElem.onerror = function() {
                    this.onerror=null; 
                    this.src=`https://placehold.co/100x170/CCCCCC/000000?text=Loi&font=IM+Fell+English+SC`;
                    this.alt='L·ªói t·∫£i ·∫£nh';
                };
            });
            cardInnerElements.forEach(innerEl => {
                const frontSymbol = innerEl.querySelector('.tarot-card-front span');
                if (frontSymbol) {
                    frontSymbol.textContent = 'üÇ†'; 
                }
            });
        };
    </script>
</body>
</html>
