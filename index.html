<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xem B√†i Tarot - ƒê·∫∑t C√¢u H·ªèi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a12;
            overflow-x: hidden;
            color: #EAE0C8;
            padding-top: 1rem;
        }

        #animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -10;
            overflow: hidden;
            background-image: url('https://i.postimg.cc/XvZQgqh2/76363ee1c9bed71a54cfe87982e86447.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        #question-section-content h2,
        .tarot-card-front,
        .btn-action,
        .card-info-title,
        .ai-title,
        #display-user-question
        {
            font-family: 'Playfair Display', serif;
        }
        .tarot-card-front {
            font-family: 'IM Fell English SC', serif;
        }


        #question-section-content h2 { font-weight: 600; font-size: 1.75rem; color: #FFD700; }
        .ai-title { font-weight: 700; font-size: 1.75rem; }
        .card-info-title { font-weight: 600; font-size: 1.3rem; }
        .btn-action { font-weight: 600; }
        #display-user-question { font-weight: 400; font-style: italic; font-size: 1.1rem; color: #F5DEB3; }


        p,
        #user-question-input::placeholder,
        .card-info-meaning,
        .ai-text,
        .ai-text .highlighted-card-name,
        .ai-text strong,
        .ai-text em,
        #initial-info-message,
        #message-text
        {
            font-family: 'Inter', sans-serif;
        }
        #user-question-input {
            font-family: 'Playfair Display', serif;
        }

        .tarot-card-front span {
            font-size: 2.5rem;
        }


        .firefly {
            position: absolute;
            width: 3px;
            height: 3px;
            background-color: rgba(220, 255, 170, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 6px 2px rgba(220, 255, 170, 0.7),
                        0 0 10px 4px rgba(255, 255, 224, 0.5);
            animation: firefly-movement 10s infinite;
            opacity: 0;
        }

        @keyframes firefly-movement {
            0%, 100% { opacity: 0.3; transform: scale(0.8) translate(0,0); }
            25% { opacity: 1; transform: scale(1.2) translate(20px, -30px); }
            50% { opacity: 0.8; transform: scale(1) translate(-15px, 25px); }
            75% { opacity: 1; transform: scale(1.1) translate(10px, 15px); }
        }

        .firefly:nth-child(1) { top: 20%; left: 10%; animation-duration: 12s; animation-delay: 0s; }
        .firefly:nth-child(2) { top: 50%; left: 80%; animation-duration: 9s; animation-delay: 1s; width: 2px; height: 2px;}
        .firefly:nth-child(3) { top: 80%; left: 30%; animation-duration: 15s; animation-delay: 2.5s; }
        .firefly:nth-child(4) { top: 10%; left: 90%; animation-duration: 10s; animation-delay: 4s; width: 4px; height: 4px;}
        .firefly:nth-child(5) { top: 65%; left: 50%; animation-duration: 13s; animation-delay: 1.5s; }


        .card-base {
            width: 100px;
            height: 170px;
            border-radius: 8px;
            background-color: #A0522D;
            border: 2px solid #8B4513;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'IM Fell English SC', serif;
            color: #F5DEB3;
            font-size: 1.8rem;
            position: absolute;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }

        #deck-pile {
            position: relative;
            width: 110px;
            height: 180px;
            margin: 20px auto;
            cursor: pointer;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; 
        }
        
        @keyframes deck-pulse-glow {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 15px 5px rgba(173, 216, 230, 0.3), 0 0 8px 2px rgba(224, 255, 255, 0.2) inset; 
            }
            50% {
                transform: scale(1.03); 
                box-shadow: 0 0 25px 10px rgba(173, 216, 230, 0.5), 0 0 12px 4px rgba(224, 255, 255, 0.4) inset;
            }
        }
        #deck-pile.shuffling {
            animation: deck-pulse-glow 1.8s ease-in-out infinite; 
        }

        @keyframes inner-card-shift {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); }
            25% { transform: translateY(-1.5px) translateX(0.5px) rotate(0.3deg); } 
            50% { transform: translateY(0.5px) translateX(-0.5px) rotate(-0.1deg); }
            75% { transform: translateY(-0.5px) translateX(0.2px) rotate(0.15deg); }
        }

        #deck-pile.shuffling .card-base {
            animation-name: inner-card-shift;
            animation-duration: 1.5s; 
            animation-iteration-count: infinite;
            animation-timing-function: cubic-bezier(0.455, 0.03, 0.515, 0.955); 
        }
        #deck-pile.shuffling .card-base:nth-child(1) { animation-delay: -0.1s; }
        #deck-pile.shuffling .card-base:nth-child(2) { animation-delay: -0.3s; }
        #deck-pile.shuffling .card-base:nth-child(3) { animation-delay: -0.5s; }
        #deck-pile.shuffling .card-base:nth-child(4) { animation-delay: -0.2s; }
        #deck-pile.shuffling .card-base:nth-child(5) { animation-delay: -0.4s; }


        @keyframes shuffle-text-wave { 
            0%, 100% { color: #ADD8E6; text-shadow: 0 0 6px #ADD8E6, 0 0 12px #ADD8E6; opacity: 0.7; transform: translateY(0); } 
            25% { color: #E0FFFF; text-shadow: 0 0 12px #E0FFFF, 0 0 18px #E0FFFF; opacity: 1; transform: translateY(-1.5px); }
            50% { color: #ADD8E6; text-shadow: 0 0 8px #ADD8E6, 0 0 15px #ADD8E6; opacity: 0.8; transform: translateY(0); }
            75% { color: #E0FFFF; text-shadow: 0 0 15px #E0FFFF, 0 0 20px #E0FFFF, 0 0 5px #AFEEEE; opacity: 1; transform: translateY(0.5px); } 
        }
        #deck-container.shuffling-active > p { 
            animation: shuffle-text-wave 2s ease-in-out infinite; 
        }


        #cards-display-area {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 200px;
            gap: 20px; 
            margin-bottom: 2rem;
            flex-wrap: wrap; 
        }

        .tarot-card-slot {
            width: 100px; 
            height: 170px;
            perspective: 1200px; 
            border-radius: 8px;
            position: relative;
        }

        .tarot-card-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1), opacity 0.5s; 
            transform-style: preserve-3d;
            border-radius: 8px;
            cursor: pointer;
            opacity: 0; 
        }
        .tarot-card-inner.dealt {
            opacity: 1; 
        }

        .tarot-card-slot.flipped .tarot-card-inner {
            transform: rotateY(180deg);
        }

        .tarot-card-front, .tarot-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .tarot-card-front {
            background-color: #A0522D; 
            color: #F5DEB3;
            border: 2px solid #8B4513; 
        }
        .tarot-card-front span { font-size: 2rem; }


        .tarot-card-back {
            background-color: #F5F5DC;
            color: #5D4037;
            transform: rotateY(180deg);
            overflow: hidden; 
        }

        .tarot-card-back img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            border-radius: 8px; 
            background-color: #F5F5DC; 
        }
        
        .tarot-card-slot.flipped .tarot-card-back {
            animation: card-reveal-glow 1.2s ease-out forwards;
            animation-delay: 0.5s; 
        }

        @keyframes card-reveal-glow {
            0% { box-shadow: 0 0 0px 0px rgba(224, 255, 255, 0); } 
            50% { box-shadow: 0 0 45px 20px rgba(175, 238, 238, 0.75), 0 0 25px 10px rgba(255, 255, 255, 0.7) inset; } 
            100% { box-shadow: 0 4px 15px rgba(0,0,0,0.35); } 
        }

        .tarot-card-slot.flipped::before,
        .tarot-card-slot.flipped::after {
            content: '';
            position: absolute;
            width: 12px; 
            height: 12px;
            background: radial-gradient(circle, rgba(224,255,255,1) 0%, rgba(175,238,238,0.8) 40%, rgba(72,209,204,0) 70%); 
            border-radius: 50%;
            opacity: 0;
            animation: sparkle-effect 1s ease-out forwards; 
            animation-delay: 0.7s; 
            pointer-events: none; 
        }

        .tarot-card-slot.flipped::before {
            top: 5%; left: 10%;
            transform: scale(0);
        }

        .tarot-card-slot.flipped::after {
            bottom: 10%; right: 5%;
            animation-delay: 0.85s; 
            transform: scale(0);
        }

        @keyframes sparkle-effect {
            0% { transform: scale(0) rotate(0deg) translateY(0px); opacity: 0; }
            20% { transform: scale(1.4) rotate(30deg) translateY(-10px); opacity: 1; }
            100% { transform: scale(0) rotate(120deg) translateY(30px); opacity: 0; }
        }


        .btn-action {
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .btn-submit-question {
            background-color: #FFD700; 
            color: #4A2311; 
            border: 1px solid #B8860B; 
            text-shadow: none; 
            font-size: 1.1rem;
            padding-top: 0.85rem;
            padding-bottom: 0.85rem;
        }
        .btn-submit-question:hover {
            background-color: #F0C000; 
            color: #3D1B0C;
        }
        #reset-cards-button {
            background-color: #8B0000; 
            color: #FFEBCD; 
            border: 1px solid #580000; 
            font-size: 1.1rem;
            padding-top: 0.85rem;
            padding-bottom: 0.85rem;
        }
        #reset-cards-button:hover {
            background-color: #580000; 
        }


        .info-section-container {
            background-color: rgba(40, 20, 0, 0.85); 
            backdrop-filter: blur(8px);
            border: 1px solid rgba(210, 180, 140, 0.3); 
            border-radius: 12px;
            padding: 25px;
            margin-top: 1rem; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); 
            width: 100%;
            max-width: 720px; 
        }
        .card-info-title {
            color: #FFD700; 
            margin-bottom: 5px;
        }
        .card-info-meaning {
            font-size: 0.95rem;
            color: #F5F5DC; 
            line-height: 1.7;
            margin-bottom: 15px; 
        }
        .ai-interpretation-container {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(210, 180, 140, 0.4); 
        }
        .ai-title {
            font-size: 1.75rem;
            color: #DAA520; 
            margin-bottom: 10px;
            text-align: center;
        }
        .ai-text {
            font-size: 1rem;
            color: #EAE0C8; 
            line-height: 1.8;
            white-space: pre-wrap; 
        }
        .ai-text .highlighted-card-name {
            color: #FFDEAD; 
            font-weight: bold;
        }
        .ai-text strong {
            color: #FFB74D; 
            font-weight: bold;
        }
        .ai-text em {
            color: #FFE0B2; 
            font-style: italic;
        }
        
        #question-section-content {
            background-color: rgba(60, 40, 20, 0.7); 
            backdrop-filter: blur(5px);
            padding: 30px;
            border-radius: 1rem; 
            margin-bottom: 30px;
            width: 100%;
            max-width: 700px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.4); 
            border: 1px solid rgba(210, 180, 140, 0.25); 
        }
        #question-section-content h2 {
            color: #FFD700; 
            margin-bottom: 1.25rem; 
        }

        #user-question-input {
            background-color: transparent;
            border: none; 
            color: #FFF8DC; 
            padding: 0.75rem 0.25rem;
            border-radius: 0; 
            font-size: 1.6rem; 
            line-height: 1.5;
            min-height: 80px; 
            resize: none; 
            outline: none; 
            width: 100%;
            text-align: center; 
        }

        #user-question-input::placeholder {
            color: rgba(210, 180, 140, 0.7); 
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: 1.6rem; 
            animation: blink-placeholder 1.5s infinite;
            text-align: center; 
        }

        #user-question-input:focus::placeholder {
            animation: none; 
            opacity: 0.4; 
        }
        #user-question-input:not(:placeholder-shown)::placeholder {
            display: none; 
        }


        @keyframes blink-placeholder {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .transitionable-section {
            transition: opacity 0.9s cubic-bezier(0.42, 0, 0.58, 1), transform 0.9s cubic-bezier(0.42, 0, 0.58, 1); 
            width: 100%;
        }

        .section-hidden-state {
            opacity: 0;
            transform: translateY(15px); 
            pointer-events: none;
        }

        .section-visible-state {
            opacity: 1;
            transform: translateY(0px);
            pointer-events: auto;
        }

        .loader {
            border: 5px solid #8B4513; 
            border-top: 5px solid #FFD700; 
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dealing-card-visual {
            width: 100px;
            height: 170px;
            border-radius: 8px;
            background-color: #A0522D; 
            border: 2px solid #8B4513;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'IM Fell English SC', serif;
            color: #F5DEB3;
            font-size: 1.8rem;
            position: fixed; 
            z-index: 1000; 
            pointer-events: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div id="animated-background">
        </div>

    <div class="w-full max-w-3xl mx-auto text-center relative z-10"> <div id="question-section-wrapper" class="transitionable-section section-visible-state"> <div id="question-section-content">
                <h2 class="mb-5">N√≥i cho ta bi·∫øt, ƒëi·ªÅu g√¨ ng∆∞∆°i t√¨m ki·∫øm?</h2>
                <textarea id="user-question-input" placeholder="V√≠ d·ª•: Con ƒë∆∞·ªùng n√†o ƒëang m·ªü ra cho ta?"></textarea>
                <button id="submit-question-button" class="btn-action btn-submit-question py-3 px-8 rounded-lg shadow-md mt-6 w-full focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
                    Kh√°m Ph√° Th√¥ng ƒêi·ªáp Tarot
                </button>
            </div>
        </div>

        <div id="tarot-reading-section-wrapper" class="transitionable-section section-hidden-state hidden"> <div id="tarot-reading-section-content">
                <p id="display-user-question" class="mt-2 mb-6"></p>
                
                <div id="deck-container" class="mb-8 hidden"> <p class="text-amber-200 mb-2 text-lg">ƒêang x√†o b√†i...</p>
                    <div id="deck-pile">
                        </div>
                </div>

                <div id="cards-display-area" class="mb-8 flex flex-wrap justify-center items-start">
                    <div id="card-slot-0" class="tarot-card-slot">
                        <div class="tarot-card-inner" data-card-index="0">
                            <div class="tarot-card-front"><span>üÇ†</span></div>
                            <div class="tarot-card-back">
                                <img src="" alt="L√° b√†i 1" id="card-img-0">
                            </div>
                        </div>
                    </div>
                    <div id="card-slot-1" class="tarot-card-slot">
                        <div class="tarot-card-inner" data-card-index="1">
                            <div class="tarot-card-front"><span>üÇ†</span></div>
                            <div class="tarot-card-back">
                                <img src="" alt="L√° b√†i 2" id="card-img-1">
                            </div>
                        </div>
                    </div>
                    <div id="card-slot-2" class="tarot-card-slot">
                        <div class="tarot-card-inner" data-card-index="2">
                            <div class="tarot-card-front"><span>üÇ†</span></div>
                            <div class="tarot-card-back">
                                <img src="" alt="L√° b√†i 3" id="card-img-2">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reset-button-container" class="mt-6 mb-4 hidden">
                    <button id="reset-cards-button" class="btn-action py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                        H·ªèi L·ªùi S·∫•m Kh√°c
                    </button>
                </div>

                <div id="info-display-section" class="info-section-container text-left hidden">
                    <div id="original-meanings-container">
                        <p id="initial-info-message" class="text-amber-100 text-center text-lg">L·ªùi ti√™n tri ƒëang ch·ªù ƒë·ª£i... H√£y ch·ªçn m·ªôt l√° b√†i!</p>
                        <div id="card-info-0" class="mb-4 p-3 bg-black bg-opacity-30 rounded-md hidden">
                            <h3 id="card-name-0" class="card-info-title"></h3>
                            <p id="card-meaning-0" class="card-info-meaning"></p>
                        </div>
                        <div id="card-info-1" class="mb-4 p-3 bg-black bg-opacity-30 rounded-md hidden">
                            <h3 id="card-name-1" class="card-info-title"></h3>
                            <p id="card-meaning-1" class="card-info-meaning"></p>
                        </div>
                        <div id="card-info-2" class="p-3 bg-black bg-opacity-30 rounded-md hidden">
                            <h3 id="card-name-2" class="card-info-title"></h3>
                            <p id="card-meaning-2" class="card-info-meaning"></p>
                        </div>
                    </div>

                    <div id="ai-interpretation-container" class="ai-interpretation-container hidden">
                        <h2 class="ai-title">üìú L·ªùi Gi·∫£i T·ª´ V√¨ Sao üìú</h2>
                        <div id="ai-loading-indicator" class="loader hidden"></div>
                        <p id="ai-interpretation-text" class="ai-text"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="message-box" class="fixed top-5 right-5 bg-red-700 text-gray-100 p-4 rounded-lg shadow-xl hidden animate-pulse z-50">
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // DOM Elements
        const animatedBackground = document.getElementById('animated-background');
        const questionSectionWrapper = document.getElementById('question-section-wrapper');
        const tarotReadingSectionWrapper = document.getElementById('tarot-reading-section-wrapper');
        
        const userQuestionInput = document.getElementById('user-question-input');
        const submitQuestionButton = document.getElementById('submit-question-button');
        const displayUserQuestionElement = document.getElementById('display-user-question');

        const deckContainer = document.getElementById('deck-container');
        const deckPile = document.getElementById('deck-pile');
        const cardSlotsElements = [ 
            document.getElementById('card-slot-0'),
            document.getElementById('card-slot-1'),
            document.getElementById('card-slot-2')
        ];
        const cardInnerElements = document.querySelectorAll('#cards-display-area .tarot-card-inner');


        const cardImages = [ 
            document.getElementById('card-img-0'),
            document.getElementById('card-img-1'),
            document.getElementById('card-img-2')
        ];
        const cardInfoDivs = [
            document.getElementById('card-info-0'),
            document.getElementById('card-info-1'),
            document.getElementById('card-info-2')
        ];
        const cardNamesElements = [
            document.getElementById('card-name-0'),
            document.getElementById('card-name-1'),
            document.getElementById('card-name-2')
        ];
        const cardMeaningsElements = [
            document.getElementById('card-meaning-0'),
            document.getElementById('card-meaning-1'),
            document.getElementById('card-meaning-2')
        ];
        const initialInfoMessage = document.getElementById('initial-info-message');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const resetButtonContainer = document.getElementById('reset-button-container');
        const resetButton = document.getElementById('reset-cards-button');

        const infoDisplaySection = document.getElementById('info-display-section');
        const originalMeaningsContainer = document.getElementById('original-meanings-container');
        const aiInterpretationContainer = document.getElementById('ai-interpretation-container');
        const aiLoadingIndicator = document.getElementById('ai-loading-indicator');
        const aiInterpretationTextElement = document.getElementById('ai-interpretation-text');

        // === √ÇM THANH - PHI√äN B·∫¢N PH√âP THU·∫¨T ƒêI·ªÜN ·∫¢NH ===
        let audioInitialized = false;
        let clickSound, shuffleAtmosphereSound, shuffleSparkleSound, dealSound, flipImpactSound, magicalChimeSound;
        let masterGain; // ƒê·ªÉ ki·ªÉm so√°t √¢m l∆∞·ª£ng t·ªïng th·ªÉ n·∫øu c·∫ßn

        function initializeSounds() {
            if (audioInitialized) return;
            try {
                masterGain = new Tone.Gain(0.7).toDestination(); // Gi·∫£m √¢m l∆∞·ª£ng t·ªïng th·ªÉ m·ªôt ch√∫t

                const cinematicReverb = new Tone.Reverb({
                    decay: 2.5, // Reverb d√†i h∆°n
                    preDelay: 0.02
                }).connect(masterGain);

                const cinematicDelay = new Tone.PingPongDelay({
                    delayTime: "4n", // Delay d√†i h∆°n
                    feedback: 0.4,   // Feedback nhi·ªÅu h∆°n
                    wet: 0.3         // T·ª∑ l·ªá √¢m thanh c√≥ hi·ªáu ·ª©ng
                }).connect(cinematicReverb);

                // Click Sound: Ethereal bell
                clickSound = new Tone.MetalSynth({
                    frequency: 440,
                    envelope: { attack: 0.001, decay: 0.3, release: 0.5 },
                    harmonicity: 3.1,
                    modulationIndex: 16,
                    resonance: 2000,
                    octaves: 1,
                    volume: -18
                }).connect(cinematicDelay);

                // Shuffle Atmosphere: Deep, slowly modulating drone
                shuffleAtmosphereSound = new Tone.AMSynth({
                    harmonicity: 1.2,
                    envelope: { attack: 2, decay: 1, sustain: 1, release: 3 },
                    modulationEnvelope: { attack: 1.5, decay: 0.5, sustain: 1, release: 2 },
                    volume: -35 // R·∫•t nh·∫π nh√†ng
                }).connect(cinematicReverb);
                const atmosphereLFO = new Tone.LFO("0.2hz", -10, 10).start(); // LFO ch·∫≠m cho detune
                atmosphereLFO.connect(shuffleAtmosphereSound.detune);
                const atmosphereFilter = new Tone.AutoFilter("0.3hz").toDestination().start();
                shuffleAtmosphereSound.connect(atmosphereFilter);


                // Shuffle Sparkles: Intermittent, bright sparkles
                shuffleSparkleSound = new Tone.FMSynth({
                    harmonicity: 5,
                    modulationIndex: 20,
                    oscillator : { type : "sine" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 },
                    modulation: { type: "triangle" },
                    modulationEnvelope: { attack: 0.01, decay: 0.05, sustain: 0, release: 0.05 },
                    volume: -25
                }).connect(cinematicDelay);


                // Deal Sound: Whoosh with pitch bend and sparkle
                dealSound = new Tone.Synth({
                    oscillator: { type: "pulse", width: 0.2 }, // Pulse wave cho √¢m thanh "m·ªèng" h∆°n
                    envelope: { attack: 0.01, decay: 0.3, sustain: 0.05, release: 0.4 },
                    volume: -16
                }).connect(cinematicDelay);
                // Pitch envelope for whoosh
                dealSound.frequency.setValueAtTime("C4", Tone.now());
                dealSound.frequency.linearRampToValueAtTime("C6", Tone.now() + 0.2);
                dealSound.frequency.linearRampToValueAtTime("G5", Tone.now() + 0.4);

                const dealSparkle = new Tone.FMSynth({ // Sparkle trail
                     harmonicity: 4, modulationIndex: 10, volume: -22,
                     envelope: {attack:0.01, decay:0.1, release:0.1}
                }).connect(cinematicDelay);


                // Flip Impact Sound: Sharp, magical "thwack" or "seal break"
                flipImpactSound = new Tone.MembraneSynth({ // √Çm thanh "thump" m·∫°nh m·∫Ω
                    pitchDecay: 0.08,
                    octaves: 3,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.15, sustain: 0.01, release: 0.2 },
                    volume: -8
                }).toDestination(); // √Çm thanh n√†y n√™n tr·ª±c ti·∫øp h∆°n

                // Magical Chime: Richer, arpeggiated, cinematic
                magicalChimeSound = new Tone.PolySynth(Tone.FMSynth, {
                    volume: -14,
                    options: { // C√†i ƒë·∫∑t cho t·ª´ng FMSynth trong PolySynth
                        harmonicity: 2.5,
                        modulationIndex: 15,
                        detune: 0,
                        oscillator: { type: "fmtriangle", partialCount: 3 },
                        envelope: { attack: 0.01, decay: 2, sustain: 0.3, release: 2.5 },
                        modulation: { type: "sine" },
                        modulationEnvelope: { attack: 0.02, decay: 1, sustain: 0.1, release: 1.5 }
                    }
                }).connect(cinematicDelay); // K·∫øt n·ªëi v·ªõi delay v√† reverb ch√≠nh


                audioInitialized = true;
                console.log("Tone.js cinematic magical sounds initialized.");
            } catch (e) {
                console.error("Error initializing Tone.js sounds:", e);
            }
        }

        let shuffleSparkleInterval;

        async function playSound(soundType, note = null, duration = null, time = null) {
            if (!audioInitialized || !Tone.context || Tone.context.state !== 'running') {
                return;
            }
            try {
                const now = Tone.now();
                switch (soundType) {
                    case 'click':
                        if (clickSound) clickSound.triggerAttackRelease("A5", "16n", now);
                        break;
                    case 'shuffleStart':
                        if (shuffleAtmosphereSound && shuffleAtmosphereSound.state !== "started") {
                            shuffleAtmosphereSound.triggerAttack(now);
                        }
                        // Start intermittent sparkles
                        if (shuffleSparkleSound) {
                            clearInterval(shuffleSparkleInterval); // Clear previous interval if any
                            shuffleSparkleInterval = setInterval(() => {
                                if (deckPile.classList.contains('shuffling')) { // Only play if still shuffling
                                    const randomNote = ["C6", "E6", "G6", "A6"][Math.floor(Math.random() * 4)];
                                    shuffleSparkleSound.triggerAttackRelease(randomNote, "32n", Tone.now() + Math.random() * 0.1);
                                } else {
                                    clearInterval(shuffleSparkleInterval);
                                }
                            }, 300 + Math.random() * 200); // Play sparkle every 300-500ms
                        }
                        break;
                    case 'shuffleStop':
                         if (shuffleAtmosphereSound && shuffleAtmosphereSound.state === "started") {
                            shuffleAtmosphereSound.triggerRelease(now + 0.8); 
                        }
                        clearInterval(shuffleSparkleInterval); // Stop sparkles
                        break;
                    case 'deal':
                        if (dealSound) {
                            dealSound.triggerAttackRelease("8n", now); // Duration controlled by envelope
                             // Play a quick sparkle with the deal sound
                            if(dealSparkle) dealSparkle.triggerAttackRelease("C7", "32n", now + 0.05);
                        }
                        break;
                    case 'flip':
                        if (flipImpactSound) {
                           flipImpactSound.triggerAttackRelease("C3", "8n", now); 
                        }
                        if (magicalChimeSound) {
                            // Arpeggiated cinematic chime
                            const notes = ["G5", "C6", "E6", "G6", "C7"];
                            let delay = 0;
                            notes.forEach(chimeNote => {
                                magicalChimeSound.triggerAttackRelease(chimeNote, "0.8", now + 0.1 + delay);
                                delay += 0.1; // Stagger notes for arpeggio
                            });
                        }
                        break;
                }
            } catch (e) {
                console.error(`Error playing sound ${soundType}:`, e);
            }
        }

        async function startAudioContext() {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log('AudioContext started by user interaction.');
            }
            initializeSounds(); 
        }


        const tarotDeck = [
            // Major Arcana (22 l√°)
            { name: "0 - The Fool (Ch√†ng Kh·ªù)", nameParts: ["The Fool", "Ch√†ng Kh·ªù", "Fool"], meaning: "S·ª± kh·ªüi ƒë·∫ßu m·ªõi, ng√¢y th∆°, phi√™u l∆∞u, ti·ªÅm nƒÉng kh√¥ng gi·ªõi h·∫°n, s·ª± t·ª± ph√°t.", img: "https://i.postimg.cc/5ND6VgDK/643e305b9f205802596736.jpg" },
            { name: "I - The Magician (Ph√°p S∆∞)", nameParts: ["The Magician", "Ph√°p S∆∞", "Magician"], meaning: "S·ª©c m·∫°nh √Ω ch√≠, k·ªπ nƒÉng, h√†nh ƒë·ªông, t·∫≠p trung, bi·ªÉu hi·ªán, t√†i nguy√™n.", img: "https://i.postimg.cc/5NpW52SB/643f51cebd6fc372602918.jpg" },
            { name: "II - The High Priestess (N·ªØ Tu)", nameParts: ["The High Priestess", "N·ªØ Tu", "High Priestess"], meaning: "Tr·ª±c gi√°c, b√≠ ·∫©n, ti·ªÅm th·ª©c, tr√≠ tu·ªá n·ªôi t√¢m, s·ª± ki√™n nh·∫´n.", img: "https://i.postimg.cc/9XnGDGvZ/6440bfeb45daa924620828.jpg" },
            { name: "III - The Empress (N·ªØ Ho√†ng)", nameParts: ["The Empress", "N·ªØ Ho√†ng", "Empress"], meaning: "S·ª± nu√¥i d∆∞·ª°ng, phong ph√∫, n·ªØ t√≠nh, s√°ng t·∫°o, v·∫ª ƒë·∫πp t·ª± nhi√™n, s·ª± sinh s√¥i.", img: "https://i.postimg.cc/sxh4Jc8B/64421dc3642e5331994313.jpg" },
            { name: "IV - The Emperor (Ho√†ng ƒê·∫ø)", nameParts: ["The Emperor", "Ho√†ng ƒê·∫ø", "Emperor"], meaning: "Quy·ªÅn l·ª±c, c·∫•u tr√∫c, s·ª± ki·ªÉm so√°t, l√Ω tr√≠, ng∆∞·ªùi cha, s·ª± ·ªïn ƒë·ªãnh.", img: "https://i.postimg.cc/Nfb5zTcL/6440ca04423aa803088771.jpg" },
            { name: "V - The Hierophant (Th·∫ßy C·∫£)", nameParts: ["The Hierophant", "Th·∫ßy C·∫£", "Hierophant"], meaning: "Truy·ªÅn th·ªëng, ƒë·ª©c tin, gi√°o d·ª•c, h∆∞·ªõng d·∫´n tinh th·∫ßn, s·ª± tu√¢n th·ªß.", img: "https://i.postimg.cc/wjygQsxC/6442143cc6d12721675057.jpg" },
            { name: "VI - The Lovers (Ng∆∞·ªùi Y√™u)", nameParts: ["The Lovers", "Ng∆∞·ªùi Y√™u", "Lovers"], meaning: "T√¨nh y√™u, m·ªëi quan h·ªá, s·ª± l·ª±a ch·ªçn, s·ª± h√≤a h·ª£p, gi√° tr·ªã, s·ª± li√™n k·∫øt.", img: "https://i.postimg.cc/hG4F3zK4/643f75de5fa42187988494.jpg" },
            { name: "VII - The Chariot (C·ªó Xe)", nameParts: ["The Chariot", "C·ªó Xe", "Chariot"], meaning: "√ù ch√≠, quy·∫øt t√¢m, chi·∫øn th·∫Øng, s·ª± ki·ªÉm so√°t, ti·∫øn v·ªÅ ph√≠a tr∆∞·ªõc, s·ª± t·ª± tin.", img: "https://i.postimg.cc/j2PkjtRk/64466e1bb9588170152785.jpg" },
            { name: "VIII - Strength (S·ª©c M·∫°nh)", nameParts: ["Strength", "S·ª©c M·∫°nh"], meaning: "S·ª©c m·∫°nh n·ªôi t√¢m, l√≤ng d≈©ng c·∫£m, s·ª± ki√™n nh·∫´n, ki·ªÉm so√°t b·∫£n nƒÉng, l√≤ng tr·∫Øc ·∫©n.", img: "https://i.postimg.cc/mg2VvQ1n/6446754309a08059278429.jpg" },
            { name: "IX - The Hermit (·∫®n Sƒ©)", nameParts: ["The Hermit", "·∫®n Sƒ©", "Hermit"], meaning: "S·ª± suy ng·∫´m, c√¥ t·ªãch, t√¨m ki·∫øm n·ªôi t√¢m, tr√≠ tu·ªá, h∆∞·ªõng d·∫´n, s·ª± t·ª± gi√°c.", img: "https://i.postimg.cc/4xmVvw9X/644776cd15b36247793217.jpg" },
            { name: "X - Wheel of Fortune (B√°nh Xe S·ªë Ph·∫≠n)", nameParts: ["Wheel of Fortune", "B√°nh Xe S·ªë Ph·∫≠n", "Wheel"], meaning: "Chu k·ª≥, s·ªë ph·∫≠n, s·ª± thay ƒë·ªïi, may m·∫Øn, b∆∞·ªõc ngo·∫∑t, c∆° h·ªôi.", img: "https://i.postimg.cc/qRjv5VPS/6448a1d65ca2c307025465.jpg" },
            { name: "XI - Justice (C√¥ng L√Ω)", nameParts: ["Justice", "C√¥ng L√Ω"], meaning: "S·ª± th·∫≠t, c√¥ng b·∫±ng, lu·∫≠t nh√¢n qu·∫£, tr√°ch nhi·ªám, s·ª± r√µ r√†ng, quy·∫øt ƒë·ªãnh.", img: "https://i.postimg.cc/J7ss2thQ/64477df6d145b114005354.jpg" },
            { name: "XII - The Hanged Man (Ng∆∞·ªùi Treo Ng∆∞·ª£c)", nameParts: ["The Hanged Man", "Ng∆∞·ªùi Treo Ng∆∞·ª£c", "Hanged Man"], meaning: "S·ª± hy sinh, g√≥c nh√¨n m·ªõi, bu√¥ng b·ªè, ƒë√¨nh ch·ªâ, s·ª± ki√™n nh·∫´n.", img: "https://i.postimg.cc/pXV6vNgk/6448ab982e324297578895.jpg" },
            { name: "XIII - Death (C√°i Ch·∫øt)", nameParts: ["Death", "C√°i Ch·∫øt"], meaning: "S·ª± k·∫øt th√∫c, chuy·ªÉn ƒë·ªïi, t√°i sinh.", img: "https://i.postimg.cc/g0pR9p72/6449de96464fc931611065.jpg" },
            { name: "XIV - Temperance (S·ª± Ti·∫øt Ch·∫ø)", nameParts: ["Temperance", "S·ª± Ti·∫øt Ch·∫ø"], meaning: "S·ª± c√¢n b·∫±ng, ƒëi·ªÅu ƒë·ªô, h√≤a h·ª£p.", img: "https://i.postimg.cc/jS46SCP7/644a8f06a2a97262712511.jpg" },
            { name: "XV - The Devil (√Åc Qu·ª∑)", nameParts: ["The Devil", "√Åc Qu·ª∑", "Devil"], meaning: "S·ª± r√†ng bu·ªôc, c√°m d·ªó, nghi·ªán ng·∫≠p.", img: "https://i.postimg.cc/L6Bgzw5d/644b42ed90c7e737329635.jpg" },
            { name: "XVI - The Tower (Ng·ªçn Th√°p)", nameParts: ["The Tower", "Ng·ªçn Th√°p", "Tower"], meaning: "S·ª± thay ƒë·ªïi ƒë·ªôt ng·ªôt, bi·∫øn ƒë·ªông.", img: "https://i.postimg.cc/qMjMBTg7/644b642cce4fe891891452.jpg" },
            { name: "XVII - The Star (Ng√¥i Sao)", nameParts: ["The Star", "Ng√¥i Sao", "Star"], meaning: "Hy v·ªçng, c·∫£m h·ª©ng, ni·ªÅm tin.", img: "https://i.postimg.cc/vHcHmKnL/6450948daadbc805081217.jpg" },
            { name: "XVIII - The Moon (M·∫∑t TrƒÉng)", nameParts: ["The Moon", "M·∫∑t TrƒÉng", "Moon"], meaning: "Tr·ª±c gi√°c, ·∫£o ·∫£nh, n·ªói s·ª£.", img: "https://i.postimg.cc/fbKJd9Rx/6450a08c8eb21261517572.jpg" },
            { name: "XIX - The Sun (M·∫∑t Tr·ªùi)", nameParts: ["The Sun", "M·∫∑t Tr·ªùi", "Sun"], meaning: "Ni·ªÅm vui, th√†nh c√¥ng, s·ª± r√µ r√†ng.", img: "https://i.postimg.cc/Kv0btDPc/642c49cb896c6121395135.png" },
            { name: "XX - Judgement (S·ª± Ph√°n X√©t)", nameParts: ["Judgement", "S·ª± Ph√°n X√©t"], meaning: "S·ª± ph√°n x√©t, s·ª± th·ª©c t·ªânh, s·ª± tha th·ª©.", img: "https://i.postimg.cc/k5bDjpsv/642c49bf40ad6363634537.png" },
            { name: "XXI - The World (Th·∫ø Gi·ªõi)", nameParts: ["The World", "Th·∫ø Gi·ªõi", "World"], meaning: "S·ª± ho√†n th√†nh, th√†nh t·ª±u, tr·ªçn v·∫πn.", img: "https://i.postimg.cc/k5bDjpsv/642c49bf40ad6363634537.png" },
            // Wands
            { name: "Ace of Wands (L√° √Åt G·∫≠y)", nameParts: ["Ace of Wands", "L√° √Åt G·∫≠y", "Ace G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Ace of Wands (L√° √Åt G·∫≠y)...", img: "https://i.postimg.cc/QCHMTYF7/64533d0cb2fa3147679879.jpg" },
            { name: "Two of Wands (L√° Hai G·∫≠y)", nameParts: ["Two of Wands", "L√° Hai G·∫≠y", "Hai G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Two of Wands (L√° Hai G·∫≠y)...", img: "https://i.postimg.cc/nL27K5hS/645349499e4af539830675.jpg" },
            { name: "Three of Wands (L√° Ba G·∫≠y)", nameParts: ["Three of Wands", "L√° Ba G·∫≠y", "Ba G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Three of Wands (L√° Ba G·∫≠y)...", img: "https://i.postimg.cc/WzNNvNLT/64534e40674ee799214954.jpg" },
            { name: "Four of Wands (L√° B·ªën G·∫≠y)", nameParts: ["Four of Wands", "L√° B·ªën G·∫≠y", "B·ªën G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Four of Wands (L√° B·ªën G·∫≠y)...", img: "https://i.postimg.cc/Pq50TCN6/64547b3fa5a62553464962.jpg" },
            { name: "Five of Wands (L√° NƒÉm G·∫≠y)", nameParts: ["Five of Wands", "L√° NƒÉm G·∫≠y", "NƒÉm G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Five of Wands (L√° NƒÉm G·∫≠y)...", img: "https://i.postimg.cc/prWF6Msn/64548481ba0db479736072.jpg" },
            { name: "Six of Wands (L√° S√°u G·∫≠y)", nameParts: ["Six of Wands", "L√° S√°u G·∫≠y", "S√°u G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Six of Wands (L√° S√°u G·∫≠y)...", img: "https://i.postimg.cc/m2GLRS48/64588f68483bc136716201.jpg" },
            { name: "Seven of Wands (L√° B·∫£y G·∫≠y)", nameParts: ["Seven of Wands", "L√° B·∫£y G·∫≠y", "B·∫£y G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Seven of Wands (L√° B·∫£y G·∫≠y)...", img: "https://i.postimg.cc/ryZ1PKLV/6461a7d1117b7390497151.jpg" },
            { name: "Eight of Wands (L√° T√°m G·∫≠y)", nameParts: ["Eight of Wands", "L√° T√°m G·∫≠y", "T√°m G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Eight of Wands (L√° T√°m G·∫≠y)...", img: "https://i.postimg.cc/BQWT0Rtk/64631c01a443e842634790.jpg" },
            { name: "Nine of Wands (L√° Ch√≠n G·∫≠y)", nameParts: ["Nine of Wands", "L√° Ch√≠n G·∫≠y", "Ch√≠n G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Nine of Wands (L√° Ch√≠n G·∫≠y)...", img: "https://i.postimg.cc/HsspVkJy/6463230887213433942331.jpg" },
            { name: "Ten of Wands (L√° M∆∞·ªùi G·∫≠y)", nameParts: ["Ten of Wands", "L√° M∆∞·ªùi G·∫≠y", "M∆∞·ªùi G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Ten of Wands (L√° M∆∞·ªùi G·∫≠y)...", img: "https://i.postimg.cc/vHL3SGX3/6464503598553047849350.jpg" },
            { name: "Page of Wands (Ti·ªÉu ƒê·ªìng G·∫≠y)", nameParts: ["Page of Wands", "Ti·ªÉu ƒê·ªìng G·∫≠y", "Page G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Page of Wands (Ti·ªÉu ƒê·ªìng G·∫≠y)...", img: "https://i.postimg.cc/xjb0m4g0/64645ee4061dd483664625.jpg" },
            { name: "Knight of Wands (Hi·ªáp Sƒ© G·∫≠y)", nameParts: ["Knight of Wands", "Hi·ªáp Sƒ© G·∫≠y", "Knight G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Knight of Wands (Hi·ªáp Sƒ© G·∫≠y)...", img: "https://i.postimg.cc/qv6XH0xP/64659fc970c60923004950.jpg" },
            { name: "Queen of Wands (N·ªØ Ho√†ng G·∫≠y)", nameParts: ["Queen of Wands", "N·ªØ Ho√†ng G·∫≠y", "Queen G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa Queen of Wands (N·ªØ Ho√†ng G·∫≠y)...", img: "https://i.postimg.cc/wTLLwFxz/6465a74ad7491577117984.jpg" },
            { name: "King of Wands (Vua G·∫≠y)", nameParts: ["King of Wands", "Vua G·∫≠y", "King G·∫≠y"], meaning: "√ù nghƒ©a c·ªßa King of Wands (Vua G·∫≠y)...", img: "https://i.postimg.cc/QxdZbYJ9/6466ed9deb5e8447525978.jpg" },
            // Cups
            { name: "Ace of Cups (L√° √Åt C·ªëc)", nameParts: ["Ace of Cups", "L√° √Åt C·ªëc", "Ace C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Ace of Cups (L√° √Åt C·ªëc)...", img: "https://i.postimg.cc/J79dyTdC/6466f735f21df317422034.jpg" },
            { name: "Two of Cups (L√° Hai C·ªëc)", nameParts: ["Two of Cups", "L√° Hai C·ªëc", "Hai C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Two of Cups (L√° Hai C·ªëc)...", img: "https://i.postimg.cc/02KRFMhP/646ae1529d382609319839.jpg" },
            { name: "Three of Cups (L√° Ba C·ªëc)", nameParts: ["Three of Cups", "L√° Ba C·ªëc", "Ba C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Three of Cups (L√° Ba C·ªëc)...", img: "https://i.postimg.cc/1zwDjHrw/646ae7d0c7f9c393213043.jpg" },
            { name: "Four of Cups (L√° B·ªën C·ªëc)", nameParts: ["Four of Cups", "L√° B·ªën C·ªëc", "B·ªën C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Four of Cups (L√° B·ªën C·ªëc)...", img: "https://i.postimg.cc/vHGMgHKs/646c3871b0cff656573075.jpg" },
            { name: "Five of Cups (L√° NƒÉm C·ªëc)", nameParts: ["Five of Cups", "L√° NƒÉm C·ªëc", "NƒÉm C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Five of Cups (L√° NƒÉm C·ªëc)...", img: "https://i.postimg.cc/vmsvMkB3/646c3f88a56de222861616.jpg" },
            { name: "Six of Cups (L√° S√°u C·ªëc)", nameParts: ["Six of Cups", "L√° S√°u C·ªëc", "S√°u C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Six of Cups (L√° S√°u C·ªëc)...", img: "https://i.postimg.cc/6qvcLvpp/646d96da452e1840500992.jpg" },
            { name: "Seven of Cups (L√° B·∫£y C·ªëc)", nameParts: ["Seven of Cups", "L√° B·∫£y C·ªëc", "B·∫£y C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Seven of Cups (L√° B·∫£y C·ªëc)...", img: "https://i.postimg.cc/nV2hpPFT/646d9b70c074f896673784.jpg" },
            { name: "Eight of Cups (L√° T√°m C·ªëc)", nameParts: ["Eight of Cups", "L√° T√°m C·ªëc", "T√°m C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Eight of Cups (L√° T√°m C·ªëc)...", img: "https://i.postimg.cc/tT5n0RvN/646ed9519c178522107302.jpg" },
            { name: "Nine of Cups (L√° Ch√≠n C·ªëc)", nameParts: ["Nine of Cups", "L√° Ch√≠n C·ªëc", "Ch√≠n C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Nine of Cups (L√° Ch√≠n C·ªëc)...", img: "https://i.postimg.cc/P55jKX1k/646edc0b30243070776066.jpg" },
            { name: "Ten of Cups (L√° M∆∞·ªùi C·ªëc)", nameParts: ["Ten of Cups", "L√° M∆∞·ªùi C·ªëc", "M∆∞·ªùi C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Ten of Cups (L√° M∆∞·ªùi C·ªëc)...", img: "https://i.postimg.cc/FKGk8sBg/64702aeda5068499557917.jpg" },
            { name: "Page of Cups (Ti·ªÉu ƒê·ªìng C·ªëc)", nameParts: ["Page of Cups", "Ti·ªÉu ƒê·ªìng C·ªëc", "Page C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Page of Cups (Ti·ªÉu ƒê·ªìng C·ªëc)...", img: "https://i.postimg.cc/TYR1MXnt/6470374da5857406158745.jpg" },
            { name: "Knight of Cups (Hi·ªáp Sƒ© C·ªëc)", nameParts: ["Knight of Cups", "Hi·ªáp Sƒ© C·ªëc", "Knight C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Knight of Cups (Hi·ªáp Sƒ© C·ªëc)...", img: "https://i.postimg.cc/6pJH5Y5b/647576a407b35333424108.jpg" },
            { name: "Queen of Cups (N·ªØ Ho√†ng C·ªëc)", nameParts: ["Queen of Cups", "N·ªØ Ho√†ng C·ªëc", "Queen C·ªëc"], meaning: "√ù nghƒ©a c·ªßa Queen of Cups (N·ªØ Ho√†ng C·ªëc)...", img: "https://i.postimg.cc/jj9cmX9h/647419538612a830624455.jpg" },
            { name: "King of Cups (Vua C·ªëc)", nameParts: ["King of Cups", "Vua C·ªëc", "King C·ªëc"], meaning: "√ù nghƒ©a c·ªßa King of Cups (Vua C·ªëc)...", img: "https://i.postimg.cc/50VYXQFV/64741e18bffd6700920912.jpg" },
            // Swords
            { name: "Ace of Swords (L√° √Åt Ki·∫øm)", nameParts: ["Ace of Swords", "L√° √Åt Ki·∫øm", "Ace Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Ace of Swords (L√° √Åt Ki·∫øm)...", img: "https://i.postimg.cc/KvM2HqH0/64757c13ea8b6430239601.jpg" },
            { name: "Two of Swords (L√° Hai Ki·∫øm)", nameParts: ["Two of Swords", "L√° Hai Ki·∫øm", "Hai Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Two of Swords (L√° Hai Ki·∫øm)...", img: "https://i.postimg.cc/pLc3VK4m/6476b134a58ac471526192.jpg" },
            { name: "Three of Swords (L√° Ba Ki·∫øm)", nameParts: ["Three of Swords", "L√° Ba Ki·∫øm", "Ba Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Three of Swords (L√° Ba Ki·∫øm)...", img: "https://i.postimg.cc/1XN3M9FH/6476b86b15021147126986.jpg" },
            { name: "Four of Swords (L√° B·ªën Ki·∫øm)", nameParts: ["Four of Swords", "L√° B·ªën Ki·∫øm", "B·ªën Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Four of Swords (L√° B·ªën Ki·∫øm)...", img: "https://i.postimg.cc/cHBpSPSS/64780715c9e4d018768073.jpg" },
            { name: "Five of Swords (L√° NƒÉm Ki·∫øm)", nameParts: ["Five of Swords", "L√° NƒÉm Ki·∫øm", "NƒÉm Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Five of Swords (L√° NƒÉm Ki·∫øm)...", img: "https://i.postimg.cc/VLmjvpPh/6478110110631060190541.jpg" },
            { name: "Six of Swords (L√° S√°u Ki·∫øm)", nameParts: ["Six of Swords", "L√° S√°u Ki·∫øm", "S√°u Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Six of Swords (L√° S√°u Ki·∫øm)...", img: "https://i.postimg.cc/rmGNYkLS/64795b7b022cf180593074.jpg" },
            { name: "Seven of Swords (L√° B·∫£y Ki·∫øm)", nameParts: ["Seven of Swords", "L√° B·∫£y Ki·∫øm", "B·∫£y Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Seven of Swords (L√° B·∫£y Ki·∫øm)...", img: "https://i.postimg.cc/vZWTnH7L/64796296d6b73591782131.jpg" },
            { name: "Eight of Swords (L√° T√°m Ki·∫øm)", nameParts: ["Eight of Swords", "L√° T√°m Ki·∫øm", "T√°m Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Eight of Swords (L√° T√°m Ki·∫øm)...", img: "https://i.postimg.cc/bJfKtpTb/647d5fe81931e198509881.jpg" },
            { name: "Nine of Swords (L√° Ch√≠n Ki·∫øm)", nameParts: ["Nine of Swords", "L√° Ch√≠n Ki·∫øm", "Ch√≠n Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Nine of Swords (L√° Ch√≠n Ki·∫øm)...", img: "https://i.postimg.cc/WtcFRD6z/647d644558d7b273724869.jpg" },
            { name: "Ten of Swords (L√° M∆∞·ªùi Ki·∫øm)", nameParts: ["Ten of Swords", "L√° M∆∞·ªùi Ki·∫øm", "M∆∞·ªùi Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Ten of Swords (L√° M∆∞·ªùi Ki·∫øm)...", img: "https://i.postimg.cc/gJ9x5Syd/647e9e2c3d8c7503771663.jpg" },
            { name: "Page of Swords (Ti·ªÉu ƒê·ªìng Ki·∫øm)", nameParts: ["Page of Swords", "Ti·ªÉu ƒê·ªìng Ki·∫øm", "Page Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Page of Swords (Ti·ªÉu ƒê·ªìng Ki·∫øm)...", img: "https://i.postimg.cc/HnNDZK59/64814fd21b2d5295209893.jpg" },
            { name: "Knight of Swords (Hi·ªáp Sƒ© Ki·∫øm)", nameParts: ["Knight of Swords", "Hi·ªáp Sƒ© Ki·∫øm", "Knight Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Knight of Swords (Hi·ªáp Sƒ© Ki·∫øm)...", img: "https://i.postimg.cc/jdzYQ82P/647ea7dda48f2377264917.jpg" },
            { name: "Queen of Swords (N·ªØ Ho√†ng Ki·∫øm)", nameParts: ["Queen of Swords", "N·ªØ Ho√†ng Ki·∫øm", "Queen Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa Queen of Swords (N·ªØ Ho√†ng Ki·∫øm)...", img: "https://i.postimg.cc/qMH9R8wR/6480010eb4dc1449235090.jpg" },
            { name: "King of Swords (Vua Ki·∫øm)", nameParts: ["King of Swords", "Vua Ki·∫øm", "King Ki·∫øm"], meaning: "√ù nghƒ©a c·ªßa King of Swords (Vua Ki·∫øm)...", img: "https://i.postimg.cc/B6Dm9VdC/648006365a61f958760163.jpg" },
            // Pentacles
            { name: "Ace of Pentacles (L√° √Åt Ti·ªÅn)", nameParts: ["Ace of Pentacles", "L√° √Åt Ti·ªÅn", "Ace Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Ace of Pentacles (L√° √Åt Ti·ªÅn)...", img: "https://i.postimg.cc/Qx6kPDF3/64815a1c931ed823839842.jpg" },
            { name: "Two of Pentacles (L√° Hai Ti·ªÅn)", nameParts: ["Two of Pentacles", "L√° Hai Ti·ªÅn", "Hai Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Two of Pentacles (L√° Hai Ti·ªÅn)...", img: "https://i.postimg.cc/ncsCFfdZ/6482870e86928273770871.jpg" },
            { name: "Three of Pentacles (L√° Ba Ti·ªÅn)", nameParts: ["Three of Pentacles", "L√° Ba Ti·ªÅn", "Ba Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Three of Pentacles (L√° Ba Ti·ªÅn)...", img: "https://i.postimg.cc/q7BtdhSD/648294ce0e9f2400968374.jpg" },
            { name: "Four of Pentacles (L√° B·ªën Ti·ªÅn)", nameParts: ["Four of Pentacles", "L√° B·ªën Ti·ªÅn", "B·ªën Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Four of Pentacles (L√° B·ªën Ti·ªÅn)...", img: "https://i.postimg.cc/Bbf44RtZ/64a2392a4e976747541841.jpg" },
            { name: "Five of Pentacles (L√° NƒÉm Ti·ªÅn)", nameParts: ["Five of Pentacles", "L√° NƒÉm Ti·ªÅn", "NƒÉm Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Five of Pentacles (L√° NƒÉm Ti·ªÅn)...", img: "https://i.postimg.cc/3w0sN9sk/64a244a218013729997109.jpg" },
            { name: "Six of Pentacles (L√° S√°u Ti·ªÅn)", nameParts: ["Six of Pentacles", "L√° S√°u Ti·ªÅn", "S√°u Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Six of Pentacles (L√° S√°u Ti·ªÅn)...", img: "https://i.postimg.cc/JhCq3qyD/64a3890bd055c236176276.jpg" },
            { name: "Seven of Pentacles (L√° B·∫£y Ti·ªÅn)", nameParts: ["Seven of Pentacles", "L√° B·∫£y Ti·ªÅn", "B·∫£y Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Seven of Pentacles (L√° B·∫£y Ti·ªÅn)...", img: "https://i.postimg.cc/FsJ3PSXj/64a393cd5db01116454428.jpg" },
            { name: "Eight of Pentacles (L√° T√°m Ti·ªÅn)", nameParts: ["Eight of Pentacles", "L√° T√°m Ti·ªÅn", "T√°m Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Eight of Pentacles (L√° T√°m Ti·ªÅn)...", img: "https://i.postimg.cc/FRd32kJ5/64a4ee1fe4fc2685238165.jpg" },
            { name: "Nine of Pentacles (L√° Ch√≠n Ti·ªÅn)", nameParts: ["Nine of Pentacles", "L√° Ch√≠n Ti·ªÅn", "Ch√≠n Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Nine of Pentacles (L√° Ch√≠n Ti·ªÅn)...", img: "https://i.postimg.cc/rmxz11rm/64a4f4bfe4079342438474.jpg" },
            { name: "Ten of Pentacles (L√° M∆∞·ªùi Ti·ªÅn)", nameParts: ["Ten of Pentacles", "L√° M∆∞·ªùi Ti·ªÅn", "M∆∞·ªùi Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Ten of Pentacles (L√° M∆∞·ªùi Ti·ªÅn)...", img: "https://i.postimg.cc/52X455cV/64a6c5b4c60e7139127123.jpg" },
            { name: "Page of Pentacles (Ti·ªÉu ƒê·ªìng Ti·ªÅn)", nameParts: ["Page of Pentacles", "Ti·ªÉu ƒê·ªìng Ti·ªÅn", "Page Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Page of Pentacles (Ti·ªÉu ƒê·ªìng Ti·ªÅn)...", img: "https://i.postimg.cc/nLvtT006/64a7c6870f965561345076.jpg" },
            { name: "Knight of Pentacles (Hi·ªáp Sƒ© Ti·ªÅn)", nameParts: ["Knight of Pentacles", "Hi·ªáp Sƒ© Ti·ªÅn", "Knight Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Knight of Pentacles (Hi·ªáp Sƒ© Ti·ªÅn)...", img: "https://i.postimg.cc/MZ3g7Czn/64a7cb5e007b1621460798.jpg" },
            { name: "Queen of Pentacles (N·ªØ Ho√†ng Ti·ªÅn)", nameParts: ["Queen of Pentacles", "N·ªØ Ho√†ng Ti·ªÅn", "Queen Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa Queen of Pentacles (N·ªØ Ho√†ng Ti·ªÅn)...", img: "https://i.postimg.cc/yx3jXrTR/64a7fd3eea247722329088.jpg" },
            { name: "King of Pentacles (Vua Ti·ªÅn)", nameParts: ["King of Pentacles", "Vua Ti·ªÅn", "King Ti·ªÅn"], meaning: "√ù nghƒ©a c·ªßa King of Pentacles (Vua Ti·ªÅn)...", img: "https://i.postimg.cc/Z5HQq2sY/64a80945cad7f503593705.jpg" }
        ];


        let revealedCount = 0;
        let availableCards = [];
        let drawnCardsData = [];
        let currentUserQuestion = "";
        let isDealing = false;

        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, duration);
        }

        function enableResetButton() { resetButtonContainer.classList.remove('hidden'); }
        function disableResetButton() { resetButtonContainer.classList.add('hidden'); }
        function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

        function createFireflies(count) {
            animatedBackground.innerHTML = ''; 
            for (let i = 0; i < count; i++) {
                const firefly = document.createElement('div');
                firefly.classList.add('firefly');
                firefly.style.top = `${Math.random() * 100}%`;
                firefly.style.left = `${Math.random() * 100}%`;
                firefly.style.animationDelay = `${Math.random() * 5}s`;
                firefly.style.animationDuration = `${8 + Math.random() * 7}s`;
                if (Math.random() > 0.6) {
                    const size = `${2 + Math.random() * 2}px`;
                    firefly.style.width = size;
                    firefly.style.height = size;
                }
                animatedBackground.appendChild(firefly);
            }
        }

        function createDeckVisual() {
            deckPile.innerHTML = ''; 
            for (let i = 0; i < 5; i++) { 
                const cardEl = document.createElement('div');
                cardEl.classList.add('card-base');
                cardEl.style.bottom = `${i * 2}px`; 
                cardEl.style.left = `${i * 1}px`;
                cardEl.textContent = 'üÇ†'; 
                deckPile.appendChild(cardEl);
            }
        }

        async function shuffleAndDeal() {
            isDealing = true;
            deckContainer.classList.remove('hidden');
            deckPile.classList.add('shuffling'); 
            deckContainer.classList.add('shuffling-active'); 
            deckContainer.querySelector('p').textContent = "ƒêang x√†o b√†i...";
            playSound('shuffleStart');
            
            await new Promise(resolve => setTimeout(resolve, 2200)); 
            
            playSound('shuffleStop');
            deckPile.classList.remove('shuffling');
            deckContainer.classList.remove('shuffling-active');
            await new Promise(resolve => setTimeout(resolve, 300)); 
            deckContainer.querySelector('p').textContent = "ƒêang chia b√†i...";
             await new Promise(resolve => setTimeout(resolve, 500)); 

            drawnCardsData = [];
            availableCards = [...tarotDeck]; 

            for (let i = 0; i < 3; i++) { 
                if (availableCards.length === 0) {
                    showMessage("Kh√¥ng ƒë·ªß b√†i ƒë·ªÉ r√∫t!", 4000);
                    break;
                }

                const randomIndex = Math.floor(Math.random() * availableCards.length);
                const selectedCardData = availableCards.splice(randomIndex, 1)[0];
                
                const cardInnerEl = cardInnerElements[i];
                const cardSlotEl = cardSlotsElements[i];
                const cardImgEl = cardInnerEl.querySelector('.tarot-card-back img');
                const cardFrontSymbolEl = cardInnerEl.querySelector('.tarot-card-front span');

                drawnCardsData.push({ data: selectedCardData, element: cardInnerEl, slot: cardSlotEl });

                cardFrontSymbolEl.textContent = 'üÇ†';
                cardImgEl.src = ""; 
                cardImgEl.alt = selectedCardData.name; 
                
                const movingCard = document.createElement('div');
                movingCard.className = 'dealing-card-visual'; 
                movingCard.textContent = 'üÇ†';
                
                const deckRect = deckPile.getBoundingClientRect();
                const slotRect = cardSlotEl.getBoundingClientRect();

                const startX = deckRect.left + window.scrollX + (deckRect.width - movingCard.offsetWidth) / 2;
                const startY = deckRect.top + window.scrollY + (deckRect.height - movingCard.offsetHeight) / 2;
                
                movingCard.style.left = `${startX}px`;
                movingCard.style.top = `${startY}px`;
                movingCard.style.transform = 'scale(0.8) rotateY(10deg)'; 
                movingCard.style.opacity = '0';
                document.body.appendChild(movingCard);

                await new Promise(resolve => setTimeout(() => {
                    movingCard.style.transition = 'transform 0.6s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.4s ease-out';
                    movingCard.style.transform = `translateY(-80px) scale(1.1) rotateY(0deg) rotateZ(-5deg)`; 
                    movingCard.style.opacity = '1';
                    playSound('deal'); 
                    resolve();
                }, 50));
                await new Promise(resolve => setTimeout(resolve, 600));

                const targetX = slotRect.left + window.scrollX + (slotRect.width - movingCard.offsetWidth) / 2;
                const targetY = slotRect.top + window.scrollY + (slotRect.height - movingCard.offsetHeight) / 2;
                
                movingCard.style.transition = 'transform 1s cubic-bezier(0.455, 0.03, 0.515, 0.955), opacity 0.8s ease-in'; 
                movingCard.style.transform = `translate(${targetX - startX}px, ${targetY - startY}px) scale(1) rotateY(-15deg) rotateZ(0deg)`; 
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                movingCard.style.transition = 'transform 0.4s ease-out, opacity 0.4s ease-out';
                movingCard.style.transform = `translate(${targetX - startX}px, ${targetY - startY}px) scale(0.95) rotateY(0deg)`; 
                movingCard.style.opacity = '0';
                
                cardInnerEl.classList.add('dealt'); 
                
                await new Promise(resolve => setTimeout(resolve, 400));
                if(movingCard.parentNode) { 
                   document.body.removeChild(movingCard); 
                }
            }
            deckContainer.classList.add('hidden'); 
            initialInfoMessage.classList.remove('hidden');
            infoDisplaySection.classList.remove('hidden');
            isDealing = false;
        }


        async function getAIInterpretation(cardsInfo, userQuestion) {
            aiInterpretationContainer.classList.remove('hidden');
            aiLoadingIndicator.classList.remove('hidden');
            aiInterpretationTextElement.innerHTML = ''; 
            const cardFullNames = cardsInfo.map(ci => ci.data.name);

            const prompt = `B·∫°n l√† m·ªôt ng∆∞·ªùi ƒë·ªçc b√†i Tarot uy√™n b√°c v√† huy·ªÅn b√≠, mang gi·ªçng vƒÉn c·ªï x∆∞a nh∆∞ m·ªôt nh√† ti√™n tri. Ng∆∞·ªùi t√¨m ki·∫øm c√≥ m·ªôt th·∫Øc m·∫Øc: "${userQuestion}". H·ªç ƒë√£ r√∫t ƒë∆∞·ª£c 3 l√° b√†i thi√™ng: ${cardFullNames.join(', ')}. D·ª±a tr√™n s·ª± th√¥ng tu·ªá Tarot c·ªßa b·∫°n, h√£y v√©n m√†n b√≠ m·∫≠t, gi·∫£i th√≠ch √Ω nghƒ©a t·ªïng h·ª£p c·ªßa 3 l√° b√†i n√†y trong m·ªëi li√™n h·ªá v·ªõi c√¢u h·ªèi c·ªßa h·ªç. H√£y ƒë∆∞a ra m·ªôt l·ªùi s·∫•m truy·ªÅn chi ti·∫øt, s√¢u s·∫Øc v√† mang t√≠nh ch·ªâ d·∫´n. Trong l·ªùi ti√™n tri c·ªßa b·∫°n, h√£y nh·∫•n m·∫°nh nh·ªØng t·ª´ kh√≥a ho·∫∑c kh√°i ni·ªám Tarot quan tr·ªçng b·∫±ng c√°ch ƒë·∫∑t ch√∫ng trong d·∫•u hai hoa th·ªã (v√≠ d·ª•: **v·∫≠n m·ªánh** ho·∫∑c **kh·ªüi ƒë·∫ßu m·ªõi**).`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            
            const apiKey = "AIzaSyBH-XIIw5BomTJtB6JrC87t5-Sz5SKy-Bw"; 
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json(); 
                    console.error("API Error Data:", errorData); 
                    throw new Error(`L·ªói t·ª´ c√°c v√¨ sao: ${errorData.error?.message || response.statusText}`);
                }
                const result = await response.json();
                let rawText = "";
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    rawText = result.candidates[0].content.parts[0].text;
                } else { 
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c l·ªùi s·∫•m truy·ªÅn h·ª£p l·ªá t·ª´ c√°c v√¨ sao."); 
                }

                let processedText = rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                const allNameParts = cardsInfo.flatMap(ci => ci.data.nameParts).sort((a, b) => b.length - a.length); 
                let tempText = processedText;
                [...new Set(allNameParts)].forEach(part => { 
                    tempText = tempText.replace(new RegExp(`\\b${escapeRegExp(part)}\\b`, 'gi'), (match) => `<span class="highlighted-card-name">${match}</span>`);
                });
                aiInterpretationTextElement.innerHTML = tempText;
            } catch (error) {
                console.error("L·ªói khi gi·∫£i l·ªùi s·∫•m:", error);
                aiInterpretationTextElement.innerHTML = `R·∫•t ti·∫øc, c√°c v√¨ sao ch∆∞a th·ªÉ h·ªìi ƒë√°p: ${error.message}. Xin h√£y th·ª≠ l·∫°i sau.`;
                showMessage(`L·ªói s·∫•m truy·ªÅn: ${error.message}`, 5000);
            } finally {
                aiLoadingIndicator.classList.add('hidden');
            }
        }

        function resetIndividualCardSlot(index) {
            const cardInnerEl = cardInnerElements[index];
            const cardSlotEl = cardSlotsElements[index]; 
            cardInnerEl.classList.remove('flipped', 'dealt');
            cardInnerEl.style.transform = ''; 
            cardSlotEl.classList.remove('flipped'); 
            
            const imgEl = cardInnerEl.querySelector('.tarot-card-back img');
            imgEl.src = ""; 
            imgEl.alt = `L√° b√†i ${index + 1}`;
            const cardFrontSymbolEl = cardInnerEl.querySelector('.tarot-card-front span');
            cardFrontSymbolEl.textContent = 'üÇ†'; 

            cardInfoDivs[index].classList.add('hidden');
            cardNamesElements[index].textContent = '';
            cardMeaningsElements[index].textContent = '';
        }

        function resetTarotReadingView() {
            cardInnerElements.forEach((el, index) => resetIndividualCardSlot(index));
            initialInfoMessage.classList.remove('hidden'); 
            infoDisplaySection.classList.add('hidden'); 
            aiInterpretationContainer.classList.add('hidden');
            aiInterpretationTextElement.innerHTML = '';
            aiLoadingIndicator.classList.add('hidden');
            disableResetButton();
            revealedCount = 0;
            drawnCardsData = []; 
        }
        
        function showSection(sectionToShow, sectionToHide) {
            sectionToHide.classList.remove('section-visible-state');
            sectionToHide.classList.add('section-hidden-state');
            
            setTimeout(() => {
                sectionToHide.classList.add('hidden'); 
                sectionToShow.classList.remove('hidden'); 
                
                requestAnimationFrame(() => { 
                    sectionToShow.classList.remove('section-hidden-state');
                    sectionToShow.classList.add('section-visible-state');
                });
            }, 900); 
        }

        function initializeNewReadingSession() {
            resetTarotReadingView();
            availableCards = [...tarotDeck]; 
            
            questionSectionWrapper.classList.remove('hidden'); 
            questionSectionWrapper.classList.remove('section-hidden-state');
            questionSectionWrapper.classList.add('section-visible-state');
            
            tarotReadingSectionWrapper.classList.remove('section-visible-state');
            tarotReadingSectionWrapper.classList.add('section-hidden-state');
            tarotReadingSectionWrapper.classList.add('hidden'); 

            userQuestionInput.value = ''; 
            currentUserQuestion = "";
            if (tarotDeck.length < 3) { 
                 showMessage("B·ªô b√†i kh√¥ng ƒë·ªß 3 l√° ƒë·ªÉ tr·∫£i. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh b·ªô b√†i.", 5000);
            }
        }

        submitQuestionButton.addEventListener('click', async () => {
            await startAudioContext(); 
            playSound('click');
            const question = userQuestionInput.value.trim();
            if (!question) {
                showMessage("Xin h√£y cho bi·∫øt ƒëi·ªÅu ng∆∞∆°i trƒÉn tr·ªü.");
                return;
            }
            currentUserQuestion = question;
            displayUserQuestionElement.textContent = `L·ªùi th·ªânh c·∫ßu c·ªßa ng∆∞∆°i: "${currentUserQuestion}"`;
            
            showSection(tarotReadingSectionWrapper, questionSectionWrapper);
            resetTarotReadingView(); 
            createDeckVisual(); 
            await shuffleAndDeal(); 
        });

        cardInnerElements.forEach((cardInnerEl, index) => {
            cardInnerEl.addEventListener('click', () => {
                if (isDealing || !cardInnerEl.classList.contains('dealt') || cardInnerEl.parentElement.classList.contains('flipped')) {
                    return;
                }
                playSound('flip');

                const cardDataObj = drawnCardsData[index]; 
                if (!cardDataObj) return; 
                
                const selectedCard = cardDataObj.data;
                const imgEl = cardInnerEl.querySelector('.tarot-card-back img');
                imgEl.src = selectedCard.img; 

                cardInnerEl.parentElement.classList.add('flipped'); 
                revealedCount++;

                cardNamesElements[index].textContent = selectedCard.name;
                cardMeaningsElements[index].textContent = selectedCard.meaning;
                cardInfoDivs[index].classList.remove('hidden');
                initialInfoMessage.classList.add('hidden'); 


                if (revealedCount === 3) { 
                    enableResetButton();
                    getAIInterpretation(drawnCardsData, currentUserQuestion);
                }
            });
        });


        resetButton.addEventListener('click', async () => {
            await startAudioContext();
            playSound('click');
            showSection(questionSectionWrapper, tarotReadingSectionWrapper);
            setTimeout(() => {
                initializeNewReadingSession();
            }, 50); 
        });

        window.onload = () => {
            initializeNewReadingSession();
            createFireflies(15); 
            cardImages.forEach((imgElem) => {
                imgElem.onerror = function() {
                    this.onerror=null; 
                    this.src=`https://placehold.co/100x170/A0522D/F5DEB3?text=L%C3%A1+B%C3%A0i&font=IM+Fell+English+SC`; 
                    this.alt='L·ªói t·∫£i ·∫£nh l√° b√†i';
                };
            });
            cardInnerElements.forEach(innerEl => {
                const frontSymbol = innerEl.querySelector('.tarot-card-front span');
                if (frontSymbol) {
                    frontSymbol.textContent = 'üÇ†';
                }
            });
        };
    </script>
</body>
</html>
